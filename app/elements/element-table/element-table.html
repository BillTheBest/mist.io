<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../element-action-menu/element-action-menu.html">
<link rel="import" href="../app-image-icons/app-image-icons.html">
<link rel="import" href="../tag-link/tag-link.html">
<link rel="import" href="machine-list-item.html">
<link rel="import" href="image-list-item.html">
<link rel="import" href="key-list-item.html">
<link rel="import" href="network-list-item.html">
<dom-module id="element-table">
    <template>
        <style>
        :host {
            display: block;
            position: relative;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 3px;
            opacity: 1;
            transition: opacity 0.4s;
        }
        
        :host(.hidden) {
            transition: none;
            opacity: 0;
        }
        
        .header {
            padding: 0 24px;
            line-height: 56px;
            font-size: 12px;
            font-weight: 500;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .check-all {
            color: white;
            margin: 8px 24px 0 0;
        }
        
        ::content .check-all iron-icon {
            color: white;
            opacity: 0.5;
        }
        
        :host([narrow-viewport]) .header >:not(.name):not(.check-all) {
            display: none;
        }
        
        :host(:not([narrow-viewport])) .header,
        :host(:not([narrow-viewport])) .row {
            @apply(--layout-horizontal);
        }
        
        :host([narrow-viewport]) .header {
            @apply(--layout-horizontal);
        }
        
        :host([narrow-viewport]) .row,
        :host([narrow-viewport]) .row a {
            @apply(--layout-vertical);
        }
        
        .row {
            border-bottom: 1px solid #e5e5e5;
        }
        
        .row a {
            box-sizing: border-box;
            width: 100%;
            padding: 15px 24px;
            font-weight: 400;
            font-size: 13px;
        }
        
        .row:nth-child(2n+1) {
            background-color: #fafafa;
        }
        
        .row.hover, .row:nth-child(2n+1).hover {
            background: #eee;
        }
        /* for when inline actions come in */
        
        :host(:not([narrow-viewport])) .row.hover >:last-child {
            /*padding-right: 120px;*/
        }
        
        .name {
            width: 250px;
            font-weight: 500;
        }
        
        .id,
        .provider,
        .tags,
        .type {
            width: 250px;
        }
        
        .is-default,
        .state {
            width: 100px;
        }
        
        .tag {
            background-color: #888;
            color: #fff;
            padding: 2px 6px;
            margin: 0 6px;
            border-radius: 2px;
        }
        
        .no-data {
            font-style: italic;
            padding: 15px 24px;
        }
        /* hide for wide */
        
        .name .narrow {
            display: none;
        }
        /* show for narrow */
        
        :host([narrow-viewport]) .name .narrow {
            display: inline;
        }
        
        :host([medium-viewport]) .name,
        :host([medium-viewport]) .type,
        :host([medium-viewport]) .provider,
        :host([medium-viewport]) .id,
        :host([medium-viewport]) .state,
        :host([medium-viewport]) .tags {
            width: 100px;
        }
        
        :host(:not([narrow-viewport])) .row .description {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #actions element-action-menu {
            right: 0;
        }
        </style>
        <iron-media-query query="(max-width: 640px)" query-matches="{{narrowViewport}}"></iron-media-query>
        <iron-media-query query="(min-width: 641px) and (max-width: 1300px)" query-matches="{{mediumViewport}}"></iron-media-query>
        <div class="header" style$="[[_getHeaderStyle(section.color)]]">
            <app-check class="check-all" selected="[[allselected]]" on-tap="_onSelectAll">
                <iron-icon icon="check"></iron-icon>
            </app-check>
            <template is="dom-if" if="[[ismachines]]">
                <div class="name">Name <span class="narrow">/ ID / Provider / State / Tags</span></div>
                <div class="id">Machine ID</div>
                <div class="provider">Provider</div>
                <div class="state">State</div>
                <div class="tags">Tags</div>
            </template>
            <template is="dom-if" if="[[isimages]]">
                <div class="name">Name <span class="narrow">/ ID / Description</span></div>
                <div class="id">Image ID</div>
                <div class="description">Description</div>
            </template>
            <template is="dom-if" if="[[iskeys]]">
                <div class="name">Name <span class="narrow">/ Default</span></div>
                <div class="is-default">Default? </div>
            </template>
            <template is="dom-if" if="[[isnetworks]]">
                <div class="name">Name <span class="narrow">/ Type / Provider</span></div>
                <div class="type">Type </div>
                <div class="provider">Provider </div>
            </template>
            <template is="dom-if" if="[[isscripts]]">
                <div class="name">Name <span class="narrow">/ Description</span></div>
                <div class="description">Description </div>
            </template>
        </div>
        <div class="row no-data" hidden$="[[elements.length]]">
            no data yet
        </div>
        <template is="dom-if" if="[[ismachines]]">
            <iron-list items="[[elements]]" as="item" selection-enabled multi-selection selected-items="{{selectedMachines}}">
                <template>
                    <div class="row" data-index$="[[index]]">
                        <machine-list-item section="[[section]]" item="[[item]]"></machine-list-item>
                    </div>
                </template>
            </iron-list>
        </template>
        <template is="dom-if" if="[[isimages]]">
            <iron-list items="[[elements]]" as="item" selection-enabled multi-selection selected-items="[[selectedImages]]">
                <template>
                    <div class="row" data-index$="[[index]]">
                        <image-list-item section="[[section]]" item="[[item]]"></image-list-item>
                    </div>
                </template>
            </iron-list>
        </template>
        <template is="dom-if" if="[[iskeys]]">
            <iron-list items="[[elements]]" as="item" selection-enabled multi-selection selected-items="[[selectedKeys]]">
                <template>
                    <div class="row" data-index$="[[index]]">
                        <key-list-item section="[[section]]" item="[[item]]"></key-list-item>
                    </div>
                </template>
            </iron-list>
        </template>
        <template is="dom-if" if="[[isnetworks]]">
            <iron-list items="[[elements]]" as="item" selection-enabled multi-selection selected-items="[[selectedNetworks]]">
                <template>
                    <div class="row" data-index$="[[index]]">
                        <network-list-item section="[[section]]" item="[[item]]"></network-list-item>
                    </div>
                </template>
            </iron-list>
        </template>
        <template is="dom-if" if="[[isscripts]]">
            <iron-list items="[[elements]]" as="item" selection-enabled multi-selection selected-items="[[selectedScripts]]">
                <template>
                    <div class="row" data-index$="[[index]]">
                        <a href$="[[_elementLink(item)]]" is="pushstate-anchor">
                            <div class="name" hidden$="[[!item.name]]">[[item.name]]</div>
                            <div class="type" hidden$="[[!item.type]]">[[item.type]]</div>
                            <div class="id" hidden$="[[!item.id]]">[[item.id]]</div>
                            <div class="provider" hidden$="[[!item.provider]]">[[item.provider]]</div>
                            <div class="description" hidden$="[[!item.description]]">[[item.description]]</div>
                            <div class="state" hidden$="[[!item.state]]">[[item.state]]</div>
                            <div class="icon" hidden$="[[!item.icons.length]]">
                                <template is="dom-if" if="[[item.icons]]">
                                    <app-image-icons feed="[[item.icons]]"></app-image-icons>
                                </template>
                            </div>
                            <div class="tags" hidden$="[[!item.tags.length]]">
                                <template is="dom-if" if="[[item.tags.length]]">
                                    <template is="dom-repeat" items="{{_itemTagsArray(item.tags)}}">
                                        <span class="tag">
                                            <template is="dom-if" if="[[item.key]]">[[item.key]] = </template>[[item.value]]
                                        </span>
                                    </template>
                                </template>
                            </div>
                        </a>
                    </div>
                </template>
        </template>
    </template>
    <div id="actions"></div>
    </template>
</dom-module>
<script>
Polymer({
    is: 'element-table',

    properties: {
        elements: {
            type: Array,
            observer: '_elementsChanged'
        },
        allselected: {
            type: Boolean,
            value: false,
            notify: true
        },
        icons: {
            type: Array
        },
        tags: {
            type: Array
        },
        section: {
            type: Object,
            notify: true
        },
        narrowViewport: {
            type: Boolean,
            reflectToAttribute: true
        },
        selectedMachines: {
            type: Array
        },
        selectedImages: {
            type: Array
        },
        selectedKeys: {
            type: Array
        },
        selectedNetworks: {
            type: Array
        },
        selectedScripts: {
            type: Array
        },
        ismachines: {
            type: Boolean,
            computed: "isMachines(section)"
        },
        isimages: {
            type: Boolean,
            computed: "isImages(section)"
        },
        iskeys: {
            type: Boolean,
            computed: "isKeys(section)"
        },
        isnetworks: {
            type: Boolean,
            computed: "isNetworks(section)"
        },
        isscripts: {
            type: Boolean,
            computed: "isScripts(section)"
        }

    },

    listeners: {
        'tap': '_tap',
        'mouseover': '_mouseOver',
        'mouseleave': '_mouseLeave'
    },

    ready: function() {
        //console.warn('element-table is ready');
    },

    isMachines: function(section) {
        if (section && section.id == "machines")
            return true;
        return false;
    },

    isImages: function(section) {
        if (section && section.id == "images")
            return true;
        return false;
    },
    isKeys: function(section) {
        if (section && section.id == "keys")
            return true;
        return false;
    },

    isNetworks: function(section) {
        if (section && section.id == "networks")
            return true;
        return false;
    },

    isScripts: function(section) {
        if (section && section.id == "scripts")
            return true;
        return false;
    },

    _currentRowIndex: -1,

    _sharedActionMenu: null,

    _findAncestor: function(node, fn) {
        while (node && fn.call(this, node)) {
            node = node.parentNode;
        }
        return node;
    },

    _tap: function(e) {
        var sourceEvent = e.detail.sourceEvent;
        var A = this._findAncestor(e.target, function(node) {
            return node != this && node.tagName !== 'A';
        });

        if (A && A.tagName === 'A' && A.href.indexOf(location.host) > 0) {
            if (sourceEvent.ctrlKey || sourceEvent.metaKey) {
                window.open(A.href);
            } else {
                this.fire('nav', {
                    url: A.href
                });
            }
        }
        console.warn('selected machines:', this.selectedMachines);
        this.fire('update-params');
    },
    _mouseOver: function(e) {
        // _mouseOver & _showActions give error with iron-list

        var row = this._findAncestor(e.target, function(node) {
            return node != this && !node.classList.contains('row') && node.id !== 'actions';
        });
        if (row && row.classList.contains('row')) {
            if (this._currentRowIndex != row.dataset.index) {
                this._hideActions();
                this._showActions(row, row.dataset.index);
            }
        } else if (row.id !== 'actions') {
            this._hideActions();
        }
    },

    _mouseLeave: function() {
        this._hideActions();
    },

    _showActions: function(row, index) {
        // _mouseOver & _showActions give error with iron-list

        var sharedActionMenu = this._sharedActionMenu;
        var rowOffsetTop = row.offsetTop;

        if (!sharedActionMenu) {
            this._sharedActionMenu = document.createElement('element-action-menu');
            this._sharedActionMenu.classList.add('hidden');
            Polymer.dom(this.$.actions).appendChild(this._sharedActionMenu);
            sharedActionMenu = this._sharedActionMenu;
        }

        sharedActionMenu.iconsOnly = true;
        sharedActionMenu.element = this.elements[index].name; //brought: Cannot read property 'undefined' of undefined
        sharedActionMenu.style.top = rowOffsetTop + 'px';

        this._layoutIfNeeded(sharedActionMenu);
        sharedActionMenu.classList.remove('hidden');
        row.classList.add('hover');

        this._currentRowIndex = index;
        this._currentRow = row;
    },

    _hideActions: function() {
        var row = this._currentRow;
        var sharedActionMenu = this._sharedActionMenu;

        if (row) {
            if (sharedActionMenu) {
                sharedActionMenu.classList.add('hidden');
            }
            row.classList.remove('hover');
            this._currentRowIndex = -1;
            this._currentRow = null;
        }
    },

    _elementLink: function(item) {
        var p, s = this.section.id;
        if (s == "machines")
            p = item.uuid
        else if (s == "images")
            p = item.id
        else if (s == "keys")
            p = item.id
        else if (s == "networks")
            p = item.name
        else if (s == "scripts")
            p = item.id //??

        return "/" + this.section.id + "/" + p;
    },

    _getHeaderStyle: function(color) {
        return 'background-color: ' + color + '; color: #fff;';
    },
    _elementsChanged: function() {

        console.warn('selected machines:', this.selectedMachines);

        // this.classList.add('hidden');
        this.async(function() {
            // this.classList.remove('hidden');
        }, 1);
    },

    _layoutIfNeeded: function(el) {
        return el.offsetTop;
    },
    _onSelectAll: function(e) {
        // e.stopPropagation();

        // check where we are at and which elements we target to select 
        this.allselected = !this.allselected;

        var els;
        if (this.ismachines)
            els = this.querySelectorAll('machine-list-item');
        if (this.isimages)
            els = this.querySelectorAll('image-list-item');
        if (this.iskeys)
            els = this.querySelectorAll('key-list-item');
        if (this.isnetworks)
            els = this.querySelectorAll('network-list-item');
        if (this.isscripts)
            els = this.querySelectorAll('script-list-item');

        // update the selectedArrays
        if (this.allselected) {
            //fill in the cooresponding selectedArray
        } else {
            //empty the cooresponding selected Array
        }
        [].forEach.call(els, function(el, index) {
            el.selected = this.allselected;
        }, this);

    }
});
</script>
