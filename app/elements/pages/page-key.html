<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../section-symbol/section-symbol.html">
<link rel="import" href="../tag-link/tag-link.html">
<link rel="import" href="../theme-color/theme-color.html">
<link rel="import" href="../element-action-menu/element-action-menu.html">
<link rel="import" href="../element-table/element-table.html">
<link rel="import" href="../element-table-cards/element-table-cards.html">
<link rel="import" href="../responsive-element/responsive-element.html">
<link rel="import" href="../element-dialog/element-dialog.html">

<dom-module id="page-key">
    <link rel="import" type="css" href="../../styles/main.css">
    <link rel="import" type="css" href="page-key.css">

    <template>
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe>

            <app-sidebar tag="[[tag]]" sections="{{sections}}" current="[[section.id]]" drawer></app-sidebar>

            <paper-header-panel id="container" mode="[[_getMode(narrowMode)]]" view$="[[_actualView(view)]]" main>
                <div class="paper-header">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <h2 class="flex">{{params.id}}
                        <span class="key-is-default">
                            <template is="dom-if" if="{{key.isDefault}}">
                                <iron-icon icon="communication:vpn-key" class="gold"></iron-icon>
                                <span>Default key</span>
                                <paper-tooltip>{{key.id}} is the default Key</paper-tooltip>
                            </template>
                            <template is="dom-if" if="{{!key.isDefault}}">
                                <paper-icon-button icon="communication:vpn-key" on-tap="makeDefault"></paper-icon-button>
                                <paper-tooltip>Make {{key.id}} the default Key</paper-tooltip>
                            </template>
                        </span>
                    </h2>
                    <app-bar class="horizontal layout center end-justified" query="{{q}}"></app-bar>
                    <paper-icon-button icon="icons:sort"></paper-icon-button>
                    <app-user-menu email="marios@mist.io"></app-user-menu>
                </div>
                <div id="content">
                    <paper-material>
                        <h2>Key ID: {{key.id}}</h2>
                        <hr/>
                        <template is="dom-if" if="{{!key.machines.length}}">
                            <p>The key is not used at any machine.</p>
                        </template>
                        <template is="dom-if" if="{{key.machines.length}}">
                            <h2>Machines:</h2>
                            <ul>
                                <template is="dom-repeat" items="{{key.machines}}">
                                    <li>{{item}}</li>
                                </template>
                            </ul>
                        </template>
                    </paper-material>
                </div>
                <div class="absolute-bottom-right">
                    <paper-menu-button vertical-align="bottom" horizontal-align="right">
                        <paper-fab icon="add" class="dropdown-trigger" alt="bottom align">Actions</paper-fab>
                        <paper-menu class="dropdown-content">
                            <paper-button on-click="addMachine">Add Machine</paper-button>
                            <template is="dom-if" if="{{!key.isDefault}}">
                                <paper-button on-tap="makeDefault">make this the default key</paper-button>
                            </template>
                            <paper-button on-click="editKey">Edit Key</paper-button>
                            <paper-button on-click="deleteKey">Delete Key</paper-button>
                        </paper-menu>
                    </paper-menu-button>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>

        <element-dialog></element-dialog>
        <iron-ajax id="keyMakeDefaultRequest" url="/keys/[[key.id]]" method="POST" on-response="handleDefaultResponse" on-error="handleError"></iron-ajax>
        <iron-ajax id="keyEditRequest" url="/keys/[[key.id]]" method="PUT" on-response="handleEditResponse" on-error="handleError"></iron-ajax>
        <iron-ajax id="keyDeleteRequest" url="/keys/[[key.id]]" method="DELETE" on-response="handleDeleteResponse" on-error="handleError"></iron-ajax>
        <paper-toast id="toast"></paper-toast>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'page-key',
        enableCustomStyleProperties: true,
        properties: {
            router: Object,
            pageTitle: {
                type: String
            },
            params: {
                type: Object,
                notify: true
            },
            sections: Array,
            section: {
                type: Object,
                notify: true,
                value: {}
            },
            tag: {
                type: String,
                value: ""
            },
            key: {
                type: Object,
                notify: true
            }
        },
        ready: function() {

        },
        attached: function() {

        },
        listInfo: function(e) {
            var info = '';
            for (var prop in this.key) {
                info += prop + " : " + this.key[prop] + ", ";
            }
            this.$.keyproperties.textContent = info;
        },
        addMachine: function(_, params) {
            // console.log("clicked Add Machine");
        },
        makeDefault: function(e) {
            this.$.keyMakeDefaultRequest.generateRequest();
        },
        handleDefaultResponse: function(data) {
            //needs to update the previous default key that it's not the default key anymore
            var k = this.model.keysArray;
            for (var i = 0, len = k.length; i < len; i++) {
                if (k[i].isDefault) {
                    k[i].isDefault = false;
                    break;
                }
            }
            this.set('key.isDefault', true);
            this.$.toast.text = key.id + ' has become your default Key!';
            this.$.toast.open();
        },
        editKey: function() {
            this.$.keyEditRequest.generateRequest();
        },
        handleEditResponse: function() {

        },
        deleteKey: function() {
            var dialog = document.querySelector('#dialog');
            dialog.modal = true;
            dialog.open();
            // this.$.keyDeleteRequest.generateRequest();
        },
        handleDeleteResponse: function() {

        },
        handleError: function() {

        }
    });
</script>
