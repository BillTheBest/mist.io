<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../item-list/item-list.html">
<link rel="import" href="../item-cards/item-cards.html">
<dom-module id="page-items">
    <template>
        <style>
        :host {
            background: #fafafa;
        }

        a {
            color: black;
            text-decoration: none;
        }

        #container {
            background: #fafafa;
        }

        .paper-header [paper-drawer-toggle] {
            margin-left: 10px;
        }

        .paper-header {
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }

        .paper-header h2 {
            margin-left: 20px;
            @apply(--layout-flex);
            text-transform: capitalize;
        }

        .paper-header .toggleViewButton {
            --paper-icon-button-ink-color: transparent;
        }

        #content {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 10px;
        }

        app-bar .menu-icon {
            margin-right: 15px;
        }

        .items-title h2 {
            @apply(--paper-font-title);
            color: #424242;
        }

        .items-title iron-icon {
            cursor: pointer;
            margin-left: 16px;
        }

        .items-title > [paper-drawer-toggle] {
            margin: 0 16px 0 0;
        }

        #section-heading .description {
            font-size: 16px;
            color: var(--paper-grey-600);
        }

        #item-cards,
        item-list,
        .items-title,
        #section-heading {
            max-width: 1500px;
            margin: 20px auto;
        }

        #section-heading {
            margin: 0px auto 16px;
        }

        [size=xs] > * {
            display: none;
        }

        [size=xs] app-sidebar paper-toolbar /deep/ #topBar {
            padding: 0 16px;
        }

        [size=xs] app-sidebar {
            min-width: 100%;
            height: auto;
        }

        #search {
            height: 48px;
            line-height: 48px;
            margin-bottom: 12px;
            position: relative;
        }

        #search iron-icon {
            margin-left: 16px;
            margin-right: 8px;
            position: absolute;
            top: 12px;
            left: 2px;
        }

        #search input {
            height: 46px;
            -webkit-appearance: none;
            line-height: 46px;
            border: 0;
            margin: 0;
            padding-left: 50px;
            border-bottom: 1px solid #e5e5e5;
            border-top: 1px solid #e5e5e5;
            @apply(--paper-font-body1);
        }

        #search input:focus {
            outline: 0;
            background-color: #eceff1;
            border-color: #cfd8dc;
        }

        #search input::-webkit-search-cancel-button {
            position: relative;
            right: 15px;
        }

        [view=cards] item-list {
            display: none;
        }

        [view=table] #item-cards {
            display: none;
        }
        </style>
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe selected="[[section]]">
            <app-sidebar model="[[model]]" tag="[[tag]]" sections="[[sections]]" current="[[section.id]]" drawer></app-sidebar>
            <paper-header-panel id="container" mode="[[_getMode(narrowMode)]]" view$="[[_actualView(view)]]" main>
                <div class="paper-header">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <h2 class="flex">[[_filteredItems.length]] [[pageTitle]]</h2>
                    <app-bar class="horizontal layout center end-justified" query="{{q}}"></app-bar>
                    <paper-icon-button class="toggleViewButton" icon="[[viewIcon]]" on-tap="toggleView" hidden$="[[_forceCards]]"></paper-icon-button>
                    <app-user-menu email="marios@mist.io"></app-user-menu>
                </div>
                <div id="content">
                    <div id="section-heading" hidden$="[[!section]]">
                        <div class="description">[[section.description]]</div>
                    </div>
                    <template is="dom-if" if="[[_stampCards(view)]]">
                        <item-cards id="item-cards" sections="[[sections]]" section="[[section]]" items="[[_filteredItems]]"></item-cards>
                    </template>
                    <template is="dom-if" if="[[_stampTable(view)]]">
                        <item-list sections="[[sections]]" section="[[section]]" items="[[_filteredItems]]" on-tag-selected="updateTag"></item-list>
                    </template>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
        <div class="absolute-bottom-right">
            <app-fab></app-fab>
        </div>
    </template>
</dom-module>
<script>
(function() {
    var _lastNavigated = null;
    Polymer({
        is: 'page-items',
        enableCustomStyleProperties: true,
        properties: {
            router: Object,
            pageTitle: {
                type: String
            },

            // Query Parameters
            q: {
                type: String,
                notify: true,
                value: '',
                observer: '_qChanged'
            },
            tag: {
                type: String,
                notify: true,
                value: ''
            },
            view: {
                type: String,
                notify: true
            },

            tagList: {
                type: Array,
                computed: 'arrayParam(tag)',
                value: function() {
                    return [];
                }
            },

            viewIcon: {
                type: String,
                computed: 'computeViewIcon(view)',
                value: 'view-module'
            },
            sections: Object,
            section: {
                type: Object,
                notify: true,
                value: {}
            },
            items: Array,

            _filteredItems: Array,
            _itemCount: Number,
            _forceCards: {
                type: Boolean
            },
        },
        observers: [
            'updateURL(q, section, tag, view, items)',
            'updateMeta(section)',
            'scrollToTop(section)'
        ],
        listeners: {
            'update-params': '_handleParamsUpdate'
        },
        ready: function() {
            this.view = this._forceCards ? 'cards' : 'table';
        },
        filter: function(item) {
            if (this.q && this.q.length && item.name.indexOf(this.q) < 0) {
                return false;
            }

            if (this.tagList.length) {
                var match = false;
                for (var i = 0; i < this.tagList.length; i++) {
                    if (item.tags.join(' ').indexOf(this.tagList[i]) >= 0) match = true;
                }
                if (!match) return false;
            }

            return true;
        },

        updateTag: function(e, detail) {
            e.stopPropagation();
            e.preventDefault();
            var newTag = detail.name;
            var t = this.tagList.slice(0);
            if (t.indexOf(newTag) < 0) t.push(newTag);
            this.tag = t.join(',');
        },
        clearTag: function() {
            this.tag = null;
        },
        updateSection: function(e) {
            e.stopPropagation();
            e.preventDefault();
            var newPkg = e.currentTarget.name;
            var p = this.sections.slice(0);
            if (p.indexOf(newPkg) < 0) p.push(newPkg);
            this.section = p.join(',');
        },
        clearSection: function() {
            this.section = null;
        },
        toggleSections: function() {
            if (this.section) {
                this.prevSection = this.section;
                this.clearSection();
            } else {
                this.section = this.prevSection;
            }
        },
        _parseQueryString: function() {
            var query = window.location.search.substring(1);
            var params = query.split('&');
            var results = [];
            for (var i = 0; i < params.length; i++) {
                var pair = params[i].split('=');
                results[pair[0]] = pair[1];
            }
            return results;
        },
        _buildQueryString: function() {
            var out = [];
            if (this.q && this.q.length) out.push("q=" + this.q);
            if (this.tag && this.tag.length) out.push("tag=" + this.tag);
            if (this.section && this.section.id && this.section.id.length) out.push("section=" + this.section.id);
            if (this.view !== 'table') out.push("view=" + this.view);

            return out.join("&");
        },
        _handleParamsUpdate: function(_, params) {
            for (var key in params) {
                this[key] = params[key];
            }
        },
        _sectionLink: function(name) {
            return '/' + name;
        },
        _qChanged: function(q) {
            if (q) {
                this.async(function() {
                    //this.$.query refers to another templates #query and so throws error on focus
                    this.$.query.focus();
                    // make sure to force the cursor to the end of the
                    // input. Only an issue in Firefox.
                    this.$.query.setSelectionRange(q.length, q.length);
                });
            }
        },
        updateURL: function(q, section, tag, view, items) {
            var qs = this._buildQueryString();
            if (qs !== _lastNavigated && this.router) {
                _lastNavigated = qs;
                this.router.go(section.id + (qs.length ? '?' + qs : ''), {
                    replace: true
                });
            }
            this.updateMeta(section);

            if (items) {
                this._filteredItems = items.filter(this.filter.bind(this));
                this._itemCount = this._filteredItems.length;
            }
            this.scrollToTop();
        },
        updateMeta: function(section) {
            if (this.q && this.q.length) {
                var t = "'" + this.q + "' ";
                t += (section && section.id) ? section.id : "";
                this.pageTitle = t;
            } else if (section && section.id) {
                this.pageTitle = section.id;
            } else if (this.tagList.length) {
                this.pageTitle = section.id + "s Tagged '" + this.tagList.join("' or '") + "'";
            } else {
                this.pageTitle = "All";
            }
            this.$.drawerPanel.closeDrawer();
        },
        toggleView: function() {
            if (this.view === 'table') {
                this.view = 'cards';
            } else {
                this.view = 'table';
            }
        },
        computeViewIcon: function(view) {
            if (view === 'table') {
                return 'view-module';
            } else {
                return 'view-list';
            }
        },
        arrayParam: function(param) {
            if (!param || !param.length) {
                return [];
            }
            return param.toString().split(',');
        },
        cartOpen: function(e) {
            this.fire('cart-open');
        },
        onSearch: function(e) {
            // when a user clicks on the (x) button we need to be sure to
            // clear the query
            this.q = this.$.query.value;
        },
        scrollToTop: function() {
            this.$.container.scroller.scrollTop = 0;
        },
        _stampCards: function(view) {
            return view === 'cards';
        },
        _stampTable: function(view) {
            return view === 'table';
        },
        closeDrawer: function() {
            this.$.drawerPanel.closeDrawer();
        },
        _actualView: function(view, force) {
            return force ? 'cards' : view;
        },
        _isEqual: function(a, b) {
            return a === b;
        },
        _getColor: function() {
            return this.section && this.section.color ? this.section.color : '';
        },

        _getMode: function(narrow) {
            return narrow ? 'waterfall' : 'scroll';
        }
    });
})();
</script>
