<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="dialog-element/dialog-element.html">

<dom-module id="cloud-info">
    <template>
        <style is="custom-style" include="dialogs"></style>
        <style include="shared-styles">
            :host {
                display: block;
                width: 100%;
            }
        </style>

        <paper-dialog entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2>[[cloud.title]]</h2>
            <paper-dialog-scrollable>
                <p>
                    <paper-input label="Title" value="{{newCloud.title}}"></paper-input>
                    <paper-button raised disabled$="[[!formReady]]" on-tap="_changeTitle">Save</paper-button>
                </p>
                <p>
                    <iron-label>State</iron-label>
                    <paper-toggle-button checked$="[[isEnabled]]" on-tap="_changeState">[[cloud.state]]</paper-toggle-button>
                </p>
                <p>
                    <paper-input id="cloudId" label="ID" value="[[cloud.id]]"></paper-input>
                    <paper-button raised on-tap="_copyId">Copy Id</paper-button>
                </p>
                <p>
                    <paper-button raised on-tap="_delete">Delete Cloud</paper-button>
                </p>
            </paper-dialog-scrollable>
        </paper-dialog>

        <dialog-element></dialog-element>
        <iron-ajax id="cloudEditAjaxRequest" url="/api/v1/clouds/[[cloud.id]]" method="PUT" on-response="_handleCloudEditAjaxResponse" on-error="_handleCloudEditAjaxError"></iron-ajax>
        <iron-ajax id="cloudStateAjaxRequest" url="/api/v1/clouds/[[cloud.id]]" method="POST" on-response="_handleCloudStateAjaxResponse" on-error="_handleCloudStateAjaxError"></iron-ajax>
        <iron-ajax id="cloudDeleteAjaxRequest" url="/api/v1/clouds/[[cloud.id]]" method="DELETE" on-response="_handleCloudDeleteAjaxResponse" on-error="_handleCloudDeleteAjaxError"></iron-ajax>
    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'cloud-info',

                properties: {
                    cloud: Object,
                    newCloud: {
                        type: Object,
                        computed: '_computeNewCloud(cloud)'
                    },
                    sendingData: {
                        type: Boolean,
                        value: false
                    },
                    formReady: {
                        type: Boolean,
                        computed: '_computeFormReady(cloud.title, newCloud.title, sendingData)'
                    },
                    isEnabled: {
                        type: Boolean,
                        computed: '_computeIsEnabled(cloud.enabled)'
                    }
                },
                listeners: {
                    'iron-overlay-closed': '_modalClosed',
                    'confirmation': '_deleteCloudEventResponse'
                },
                _computeNewCloud: function(cloud) {
                    return {
                        title: cloud.title
                    }
                },
                _computeIsEnabled: function(enabled) {
                    return enabled;
                },
                _computeFormReady: function(title, newTitle, sendingData) {
                    var formReady = false;

                    if (newTitle && newTitle != title) {
                        formReady = true;
                    }

                    if (sendingData) {
                        formReady = false;
                    }

                    return formReady;
                },
                _openDialog: function(e) {
                    this.querySelector('paper-dialog').open();
                },
                _closeDialog: function(e) {
                    this.querySelector('paper-dialog').close();
                },
                _changeTitle: function() {
                    this.$.cloudEditAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.cloudEditAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.cloudEditAjaxRequest.body = {
                        new_name: this.newCloud.title
                    };
                    this.$.cloudEditAjaxRequest.generateRequest();

                    this.set('sendingData', true);
                },
                _handleCloudEditAjaxResponse: function() {
                    this.set('cloud.title', this.newCloud.title);
                    this.set('sendingData', false);
                },
                _changeState: function(e) {
                    this.$.cloudStateAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.cloudStateAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.cloudStateAjaxRequest.body = {
                        new_state: this.cloud.enabled ? '0' : '1'
                    };
                    this.$.cloudStateAjaxRequest.generateRequest();

                    this.set('sendingData', true);
                },
                _handleCloudStateAjaxResponse: function(e) {
                    this.set('cloud.enabled', !this.cloud.enabled);
                    this.set('cloud.state', this.cloud.enabled ? 'online' : 'offline');
                    this.set('sendingData', false);
                },
                _copyId: function() {
                    this.querySelector('#cloudId input').select();
                    document.execCommand('copy');
                },
                _delete: function() {
                    this._showDialog({
                        title: 'Delete Cloud?',
                        body: "Deleting a cloud can not be undone. You are about to delete cloud '" + this.cloud.title + "'.",
                        danger: true,
                        reason: "cloud.delete"
                    });
                },
                _showDialog: function(info) {
                    var dialog = this.querySelector('dialog-element');
                    for (var i in info) {
                        dialog[i] = info[i];
                    }
                    dialog._openDialog();
                },
                _deleteCloudEventResponse: function(e) {
                    var reason = e.detail.reason,
                        response = e.detail.response;

                    if (response.confirmed && reason == "cloud.delete") {
                        this.$.cloudDeleteAjaxRequest.body = {};
                        this.$.cloudDeleteAjaxRequest.headers["Content-Type"] = 'application/json';
                        this.$.cloudDeleteAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                        this.$.cloudDeleteAjaxRequest.generateRequest();
                    }
                },
            });
        })();
    </script>
</dom-module>
