<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../app-image-icons/app-image-icons.html">

<link rel="import" href="../tag-link/tag-link.html">

<link rel="import" href="machine-list-item.html">
<link rel="import" href="image-list-item.html">
<link rel="import" href="key-list-item.html">
<link rel="import" href="network-list-item.html">

<dom-module id="item-list">
    <template>
        <style>
        :host {
            display: block;
            position: relative;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 3px;
            opacity: 1;
            transition: opacity 0.4s;
        }

        :host(.hidden) {
            transition: none;
            opacity: 0;
        }

        .header iron-icon {
            fill: #fff;
        }

        iron-list {
            overflow-y: auto;
            overflow-x: hidden;
        }

        paper-button {
            padding: 0 0 0 1em;
        }

        paper-button.more {
            margin-right: 0px;
            right: 0;
        }

        .row paper-button.more {
            position: absolute;
            top: 0;
            right: 0px;
            padding: 27px 0;
        }

        .row paper-button.more iron-icon {
            float: right;
            margin-right: 12px;
        }

        paper-button > span {
            padding: 0 1em;
        }

        app-check {
            margin-right: 24px;
            margin-top: 6px;
        }

        div.actions {
            width: 100%;
            float: right;
            text-align: right;
        }

        .header {
            padding: 0 24px;
            line-height: 56px;
            font-size: 12px;
            font-weight: 500;
            border-bottom: 1px solid #e5e5e5;
        }

        .header > .item-list {
            text-transform: capitalize;
        }

        .check-all {
            color: white;
            margin: 8px 24px 0 0;
        }

        ::content .check-all iron-icon {
            color: white;
            opacity: 0.5;
        }

        :host(:not([narrow-viewport])) .header,
        :host(:not([narrow-viewport])) .row {
            @apply(--layout-horizontal);
        }

        :host([narrow-viewport]) .header {
            @apply(--layout-horizontal);
        }

        :host([narrow-viewport]) .row,
        :host([narrow-viewport]) .row a {
            @apply(--layout-vertical);
        }

        .row {
            border-bottom: 1px solid #e5e5e5;
        }

        .row a {
            box-sizing: border-box;
            width: 100%;
            padding: 15px 24px;
            font-weight: 400;
            font-size: 13px;
        }

        .row:nth-child(2n+1) {
            background-color: #fafafa;
        }

        .row:nth-child(2n) {
            background-color: #fff;
        }

        .row.hover, .row:nth-child(2n+1).hover {
            background: #eee;
        }
        /* for when inline actions come in */

        :host(:not([narrow-viewport])) .row.hover >:last-child {
            /*padding-right: 120px;*/
        }

        .field.desc, .field.asc {
            font-weight: 600;
        }

        .field.field0 {
            min-width: 250px;
            font-weight: 500;
        }

        .field {
            min-width: 150px;
            margin-right: 24px;
        }

        .tag {
            background-color: #888;
            color: #fff;
            padding: 2px 6px;
            margin: 0 6px;
            border-radius: 2px;
        }

        .no-data {
            font-style: italic;
            padding: 15px 24px;
        }

        /* hide for wide */
        .header > .narrow {
            display: none;
        }

        /* show for narrow */
        :host([narrow-viewport]) .header > div.field,
        :host([narrow-viewport]) .header span {
            display: none;
        }

        :host([narrow-viewport]) .header > .narrow {
            display: inline !important;
        }

        :host(:not([narrow-viewport])) .row .description {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        </style>

        <iron-media-query query="(max-width: 640px)" query-matches="{{narrowViewport}}"></iron-media-query>
        <iron-media-query query="(min-width: 641px) and (max-width: 1300px)" query-matches="{{mediumViewport}}"></iron-media-query>
        <div class="header" style$="[[_getHeaderStyle(section.color, selectedItems.length)]]">
            <app-check class="check-all" selected="[[allselected]]" on-tap="_onSelectAll">
                <template is="dom-if" if="{{!selectedItems.length}}">
                    <iron-icon icon="check"></iron-icon>
                </template>
                <template is="dom-if" if="[[selectedItems.length]]">
                    <strong>[[selectedItems.length]]</strong>
                </template>
            </app-check>

            <template is="dom-if" if="[[!selectedItems.length]]">
              <template is="dom-repeat" items="[[fields]]">
                  <div class$="{{item}} field field[[index]] {{_isSortedBy(item, sortBy, sortOrder)}}" on-tap="_changeSortOrder">
                      [[item]]
                  </div>
              </template>
              <div class="field tags">tags</div>

              <span class="narrow">Sort&nbsp;by:&nbsp;[[sortBy]]&nbsp;[[_isSortedBy(sortBy, sortBy, sortOrder)]]</span>
            </template>

            <div class="actions">
              <template is="dom-if" if="[[selectedItems.length]]">
                <template is="dom-repeat" items="{{topActions}}">
                    <paper-button><iron-icon icon="[[item.icon]]"></iron-icon> <span>[[item.name]]</span></paper-button>
                </template>
              </template>
              <template is="dom-if" if="[[moreActions.length]]">
                <paper-button class="more"><iron-icon icon="more-vert"></iron-icon></paper-button>
              </template>
            </div>
        </div>
        <div class="row no-data" hidden$="[[items.length]]">
            no data yet
        </div>
        <iron-list items="[[items]]" as="item" style$="[[vpHeight]]">
            <template>
                <div class="row" data-index$="[[index]]">
                  <template is="dom-if" if="[[ismachines]]">
                    <machine-list-item section="[[section]]" item="[[item]]" fields="[[fields]]" id$="[[itemUid(item)]]">
                      <app-check id="check"  allselected="{{allselected}}" selected$="{{isSelected(item, selectedItems.splices)}}" item="[[item]]" on-tap="_selectItem">M</app-check>
                      <paper-tooltip for="check" position="right">Select item</paper-tooltip>
                    </machine-list-item>
                  </template>
                  <template is="dom-if" if="[[isimages]]">
                    <image-list-item section="[[section]]" item="[[item]]" fields="[[fields]]"></image-list-item>
                  </template>
                  <template is="dom-if" if="[[iskeys]]">
                    <key-list-item section="[[section]]" item="[[item]]" fields="[[fields]]"></key-list-item>
                  </template>
                  <template is="dom-if" if="[[istemplates]]">
                    <template-list-item section="[[section]]" item="[[item]]" fields="[[fields]]"></template-list-item>
                  </template>
                  <paper-button class="more"><iron-icon icon="more-vert"></iron-icon></paper-button>
                </div>
            </template>
        </iron-list>
    </template>
    <div id="actions"></div>
    </template>
</dom-module>

<script>
ACTION_ICONS = {
  'destroy': 'delete',
  'reboot': 'av:replay',
  'tag': 'label',
  'shell': 'vaadin:terminal'
};

Polymer({
    is: 'item-list',

    properties: {
        items: {
            type: Array,
            value: []
        },
        selectedItems: {
            type: Array,
            value: [],
            notify: true
        },
        allselected: {
            type: Boolean,
            value: false
        },
        sortBy: {
            type: String,
            notify: true
        },
        sortOrder: {
            type: Number,
            notify: true
        },
        actions: {
            type: Array,
            value: []
        },
        topActions: {
            type: Array,
            computed: "_topActions(actions)"
        },
        moreActions: {
            type: Array,
            computed: "_moreActions(actions)"
        },
        icons: {
            type: Array
        },
        tags: {
            type: Array
        },
        section: {
            type: Object,
            notify: true
        },
        narrowViewport: {
            type: Boolean,
            reflectToAttribute: true
        },
        mediumViewport: {
            type: Boolean,
            reflectToAttribute: true
        },
        ismachines: {
            type: Boolean,
            computed: "isMachines(section)"
        },
        isimages: {
            type: Boolean,
            computed: "isImages(section)"
        },
        iskeys: {
            type: Boolean,
            computed: "isKeys(section)"
        },
        isnetworks: {
            type: Boolean,
            computed: "isNetworks(section)"
        },
        isscripts: {
            type: Boolean,
            computed: "isScripts(section)"
        },
        fields: {
            type: Array,
            computed: "displayedFields(section, narrowViewport, mediumViewport)"
        },
        vpHeight: String
    },

    listeners: {
        //'tap': '_tap',
        //'mouseover': '_mouseOver',
        //'mouseleave': '_mouseLeave',
    },

    observers: [
      'itemsChanged(items.splices)',
      'selectedItemsChanged(selectedItems.splices)',
    ],

    ready: function() {
        var wh = window.innerHeight - 187;
        this.vpHeight = 'height:'+ wh +'px;';
    },

    itemsChanged: function (changeRecord) {
        // If some selectedItems are no longer in the items list, unselect them
        if (!this.selectedItems)
            return;
        var oldSelected = this.get('selectedItems').slice(0);
        while (this.get('selectedItems.length')) {
            this.pop('selectedItems');
        }
        for (var i=0; i < this.items.length; i++) {
            if (oldSelected.indexOf(this.itemUid(this.items[i]))>-1) {
              this.push('selectedItems', this.itemUid(this.items[i]));
            }
        }
        if (this.get('items.length') != this.get('selectedItems.length'))
            this.set('allselected', false);

        // Not sure if this is needed
        this.querySelector('iron-list').notifyResize();
    },

    selectedItemsChanged: function (changeRecord) {
        // recompute the actions array property as the intersection
        // of the available actions of the selected items
        if (!this.selectedItems || !this.selectedItems.length)
            this.set('actions', []);
        var actions = new swiftSet.Set(), isection = new swiftSet.Set();
        actions.addItems(this.itemActions(this.selectedItems[0]) || []);
        for (var i=1; i<this.selectedItems.length; i++) {
            isection.clear()
            isection.addItems(actions.intersection(this.itemActions(this.selectedItems[i])));
            actions.clear();
            actions.addItems(isection.items());
        }

        var res = actions.items(), ret = [];
        for (var i=0; i<res.length; i++) {
            ret.push({'name': res[i],
                      'icon': ACTION_ICONS[res[i]]})
        }
        this.set('actions', ret);
    },


    itemUid: function(item) {
        // Returns a universal resource id of the form
        //      resourceType:[cloudId]:itemId
        // e.g. machine:3tm7aaHHZcMxpZ:bf04f27e924fa67023582,
        //      key::MnhLdx9u22YjVJ
        //
        // TODO replace with mist uuids

        // if item type is not defined derive it fro the current section id
        var item_type = item.type ? item.type : (this.section &&
                                                 this.section.id.slice(0,-1));
        var cloudId = item.cloud ? item.cloud.id : '';

        return item_type + ':' + cloudId + ':' + item.id;
    },

    itemIndex: function(itemUid) {
        // returns the index of the item in the items list based on the itemUid

        var chunks = itemUid.split(':'),
            itemId = chunks[2];
            cloudId = chunks[1];

        for (var i = 0; i < this.items.length; i++) {
            if (this.items[i].id == itemId && (!cloudId || cloudId == this.items[i].cloud.id))
                return i;
        }
        return -1;
    },

    itemActions: function(itemUid) {
        // the list of available actions for this item based on the itemUid

        if (!itemUid)
            return [];

        var ret = [],
            index = this.itemIndex(itemUid),
            item_type = itemUid.split(':')[0];

        if (index == -1)
            return []

        var item = this.items[index];
        if (item_type == 'machine') {
            if (item.state == 'running') {
              // if key then add shell / run script
              // if not monitoring then enable monitoring
              ret.push('shell');
              ret.push('tag');
              ret.push('reboot');
            } else {
              ret.push('tag');
            }
            ret.push('destroy');
        } else if (item_type == 'image') {
            return ret;
        }
        return ret;
    },

    isMachines: function(section) {
        if (section && section.id == "machines")
            return true;
        return false;
    },

    isImages: function(section) {
        if (section && section.id == "images")
            return true;
        return false;
    },

    isKeys: function(section) {
        if (section && section.id == "keys")
            return true;
        return false;
    },

    isNetworks: function(section) {
        if (section && section.id == "networks")
            return true;
        return false;
    },

    isScripts: function(section) {
        if (section && section.id == "scripts")
            return true;
        return false;
    },

    isSelected: function(item, selectedItems, items) {
        return this.selectedItems.indexOf(this.itemUid(item)) > -1;
    },

    displayedFields: function (section) {
        if (this.isMachines(section))
          if (!this.get('mediumViewport') && !this.get('narrowViewport'))
              return ['name', 'state', 'cloud', 'id', 'image'];
          else
              return ['name', 'state', 'cloud'];
        if (this.isKeys(section))
          return ['name']
    },

    _topActions: function (actions) {
        return actions.slice(0, 3);
    },

    _moreActions: function (actions) {
        return actions.slice(3);
    },

    _selectItem: function(e, g) {
        var item = e.model.item,
            index = this.selectedItems.indexOf(this.itemUid(item)),
            checkbox = g.sourceEvent.target.parentNode.parentNode;

        if (index > -1) { // deselect
            this.splice('selectedItems', index, 1);
            //checkbox.set('selected', false);
            this.set('allselected', false);
        } else { // select
            this.push('selectedItems', this.itemUid(item));
            //checkbox.set('selected', true);
            if (this.get('selectedItems.length') == this.get('items.length')){
                this.set('allselected', true);
            }
        }
    },

    _changeSortOrder: function(e, g) {
        console.warn('sort order', e.model.item);
        if (this.get('sortBy') != e.model.item) {
            this.set('sortBy', e.model.item);
            this.set('sortOrder', 0);
        } else if (!this.get('sortOrder')){
            this.set('sortOrder', 1);
        } else {
            //this.set('sortBy', 'default');
            this.set('sortOrder', 0);
        }
    },

    _isSortedBy: function (e) {
        console.info(e, this.sortBy, e == this.sortBy && (this.sortOrder ? 'desc' : 'asc'));
        if (e == this.sortBy)
          return this.sortOrder ? 'desc' : 'asc';
    },

    _currentRowIndex: -1,

    _sharedActionMenu: null,

    _findAncestor: function(node, fn) {
        while (node && fn.call(this, node)) {
            node = node.parentNode;
        }
        return node;
    },

    _tap: function(e) {
        var sourceEvent = e.detail.sourceEvent;
        var A = this._findAncestor(e.target, function(node) {
            return node != this && node.tagName !== 'A';
        });

        if (A && A.tagName === 'A' && A.href.indexOf(location.host) > 0) {
            if (sourceEvent.ctrlKey || sourceEvent.metaKey) {
                window.open(A.href);
            } else {
                this.fire('nav', {
                    url: A.href
                });
            }
        }
        this.fire('update-params');
    },

    _mouseOver: function(e) {
        // _mouseOver & _showActions give error with iron-list

        var row = this._findAncestor(e.target, function(node) {
            return node != this && !node.classList.contains('row') && node.id !== 'actions';
        });
        if (row && row.classList.contains('row')) {
            if (this._currentRowIndex != row.dataset.index) {
                this._hideActions();
                this._showActions(row, row.dataset.index);
            }
        } else if (row.id !== 'actions') {
            this._hideActions();
        }
    },

    _mouseLeave: function() {
        this._hideActions();
    },

    _showActions: function(row, index) {
        // TODO
        /*
        // _mouseOver & _showActions give error with iron-list

        var sharedActionMenu = this._sharedActionMenu;
        var rowOffsetTop = row.offsetTop;

        if (!sharedActionMenu) {
            this._sharedActionMenu = document.createElement('element-action-menu');
            this._sharedActionMenu.classList.add('hidden');
            Polymer.dom(this.$.actions).appendChild(this._sharedActionMenu);
            sharedActionMenu = this._sharedActionMenu;
        }

        sharedActionMenu.iconsOnly = true;
        sharedActionMenu.element = this.elements[index].name; //brought: Cannot read property 'undefined' of undefined
        sharedActionMenu.style.top = rowOffsetTop + 'px';

        this._layoutIfNeeded(sharedActionMenu);
        sharedActionMenu.classList.remove('hidden');
        row.classList.add('hover');

        this._currentRowIndex = index;
        this._currentRow = row;*/
    },

    _hideActions: function() {
        /* TODO
        var row = this._currentRow;
        var sharedActionMenu = this._sharedActionMenu;

        if (row) {
            if (sharedActionMenu) {
                sharedActionMenu.classList.add('hidden');
            }
            row.classList.remove('hover');
            this._currentRowIndex = -1;
            this._currentRow = null;
        }*/
    },

    _itemLink: function(item) {
        var p, s = this.section.id;
        if (s == "machines")
            p = item.uuid
        else if (s == "images")
            p = item.id
        else if (s == "keys")
            p = item.id
        else if (s == "networks")
            p = item.name
        else if (s == "scripts")
            p = item.id //??

        return "/" + this.section.id + "/" + p;
    },

    _getHeaderStyle: function(color, selectedItemsLength) {
        if (selectedItemsLength > 0)
            return 'background-color: #666; color: #fff; padding-right: 0px;';
        else
            return 'background-color: ' + color + '; color: #fff;';

    },

    _layoutIfNeeded: function(el) {
        return el.offsetTop;
    },

    _onSelectAll: function(e) {
        //var els = this.querySelectorAll('iron-list .row > .item-list > app-check'), selectAll = this.allselected;
        this.set('allselected', !this.allselected);
        if (this.allselected) {
            for (var i=0; i<this.items.length; i++){
                if (this.selectedItems.indexOf(this.itemUid(this.items[i]))==-1)
                    this.push('selectedItems', this.itemUid(this.items[i]));
            }
            //[].forEach.call(els, function(el, index) {
                //el.set('selected', true);
            //}, this);
        } else {
            while (this.get('selectedItems.length')) {
                this.pop('selectedItems');
            }
            //this.set('selectedItems', []);
            //this.querySelector('iron-list').clearSelection();
            //[].forEach.call(els, function(el, index) {
                //el.set('selected', false);
            //}, this);
        }

    }
});

</script>
