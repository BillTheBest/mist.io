<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../helpers/dialog-element.html">
<link rel="import" href="../tags/tags-list.html">
<link rel="import" href="../item-list/item-actions.html">
<link rel="import" href="../element-for-in/element-for-in.html">

<link rel="import" href="machine-edit.html">

<dom-module id="machine-page">
    <template>
        <style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="info-table-style"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }
            .columns {
                @apply(--layout-horizontal);  
                flex: 1 100%;
                margin-bottom: 16px;
            }
            .columns paper-material > * {
                word-break: break-all;
            }
            .left, .right {
                @apply(--layout-vertical);
                align-items: flex-start;
                flex-direction: column;
                flex: 1 100%;
            }
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
                align-content: stretch;
                flex: 100%;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .paper-header h2 {
                @apply(--layout-flex-none);
            }

            .machine-ip {
                margin: 0;
            }

            paper-material {
                padding: 24px;
                box-sizing: border-box;
                width: 100%;
            }
            paper-material.info-card {
                padding: 0;
            }
            paper-material > h2 {
                line-height: initial !important;
                margin-bottom: 0;
                cursor: pointer;
            }

            .subhead {
                box-sizing: border-box;
                position: absolute;
                width: 100%;
                left: 0;
                height: 57px;
                bottom: -57px;
                right: 0;
                z-index: 9;
                color: rgba(0, 0, 0, 0.87);
            }

            paper-header-panel::content #dropShadow {
                top: 56px;
            }

            paper-toolbar::content #bottomBar .right-actions {
                transition: var(--paper-toolbar-transition, margin-right 0.18s ease-in);
            }

            paper-toolbar:not(.tall)::content #bottomBar .right-actions {
                margin-right: 70px;
            }

            .label {
                padding: 2px !important;
            }

            #machine_actions paper-button {
                text-align: left !important;
            }
            .machine-state-icon {
                background-color: #fff !important;
            }
            .machine-state-icon.running {
                color: var(--green-color) !important;
            }

            .machine-state-icon.terminated {
                color: var(--mist-dark-color) !important;
            }

            .machine-state-icon.stopped {
                color: var(--orange-color) !important;
            }

            .machine-state-icon.error {
                color: var(--red-color) !important;
            }

            .machine-state-icon.unknown, .machine-state-icon.pending {
                color: #ccc !important;
            }

            paper-material > .smallcaps {
                margin-top: 0;
            }
            :host .tag {
                display: inline !important;
                padding: 4px;
                margin: 4px;
            }
            polyana-dashboard ::content h3 {
                text-transform: uppercase;
                font-size: 16px;
                font-weight: 400;
                line-height: 36px;
                margin: 0 24px 0 0;
            }
            polyana-dashboard ::content timerange-picker {
                position: absolute;
                right: 0;
                top: 12px;
            }
            polyana-dashboard ::content paper-button {
                margin: 0;
                min-width: 1px;
            }
            polyana-dashboard ::content paper-spinner {
                display: block;
                margin: 0 auto;
            }
            paper-button[disabled] {
                opacity: 0.54
            }
            paper-button.left-icon iron-icon {
                margin: 0 4px 0 0;
            }
            paper-button.right-icon iron-icon {
                margin: 0 0 0 4px;
            }
            .machine-key {
                line-height: 24px;
                display: inline-block;
                vertical-align: top;
            }
            .machine-key iron-icon {
                margin-right: 8px;
                opacity: 0.32;
                cursor: pointer;
            }
            .machine-key iron-icon[icon='close'] {
                opacity: 0;
                margin-right: 16px;
            }
            .machine-key:hover iron-icon[icon='close'] {
                opacity: 0.32;
            }
            #pendingKeyrequest paper-spinner {
                width: 24px !important;
                height: 24px !important;
                vertical-align: middle !important;
            }
            .machine-actions > * {
                /*vertical-align: middle;*/
            }
            .machine-actions > paper-button.left-icon iron-icon {
                /*padding-right: 8px;*/
            }
            .machine-actions > paper-button.right-icon iron-icon {
                /*padding-left: 8px;*/
            }
            item-actions {
                display: flex;
                font-size: 1em;                
            }
            item-actions ::content .actions {
                height: auto;
                display: flex;
                vertical-align: auto;
                padding: 0;
            }
        </style>

        <div id="content">
            <div class="is-loading" hidden$="[[!isLoading]]">
                <paper-spinner active hidden$="[[!isLoading]]"></paper-spinner>
            </div>
            <paper-material class="single-head layout horizontal" style$="color:#fff;background-color: [[section.color]];">
                <span class="icon"><iron-icon class$=" machine-state-icon [[machine.state]]" icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        [[machine.name]]
                    </h2>
                    <div class="subtitle">
                        [[machine.state]] <span class="desc" hidden$="[[isState(machine)]]">[[machine.extra.status]]</span>
                    </div>
                </div>
                <div class="machine-actions">
                    <item-actions id="actions" items="[[itemInArray]]" selected-items="[[itemUid]]" selected-item="[[machine]]" section="[[section]]" actions="[[actions]]" org="[[model.org]]" model="[[model]]"></item-actions>
                </div>
            </paper-material>
            <div class="columns">
                <paper-material id="leftcolumn" class="left">
                    <h3 class="smallcaps">Info:</h3>
                    <span hidden$="[[!machine.cloud.title]]">Cloud: [[machine.cloud.title]]</span>
                    <span hidden$="[[!machine.extra.image]]">Image: [[machine.extra.image]]</span>
                    <span hidden$="[[!machine.extra.created]]">Created: [[machine.extra.created]]</span>
                </paper-material>
                <paper-material id="rightcolumn" class="right" hidden$="[[hideAssociatedKeys]]">
                    <h3 class="smallcaps">Associated Keys:</h3>
                    <div class="associatedKeys">
                        <template is="dom-repeat" items="[[associatedKeys]]">
                            <div class="machine-key">
                                <a class="regular blue-link flexchild" href$="/keys/[[item.id]]"><iron-icon icon="communication:vpn-key"></iron-icon> [[item.name]]</a>
                                <iron-icon data-keyid="[[item.id]]" data-keyname="[[item.name]]" icon="close" on-tap="disassociateKey"></iron-icon>
                            </div>
                        </template>
                        <div class="machine-key" id="pendingKeyRequest">
                            <paper-spinner active hidden$="[[!isPendingKeyRequest]]"></paper-spinner>
                        </div>
                    </div>
                </paper-material>
                <paper-material id="rightcolumn" class="right" hidden$="[[!machine.tags.length]]">
                    <h3 class="smallcaps">TAGS:</h3>
                    <template is="dom-repeat" items="[[machine.tags]]">
                        <span class="tag">[[item.key]]<span hidden$="[[!item.value]]">=</span>[[item.value]]</span>
                    </template>
                </paper-material>
            </div>
            <!--<paper-material class="info-card" hidden$="{{!isMonitored}}">
                <h2 style$="color:#fff;background-color: [[section.color]];">Monitoring</h2>
                <div>
                    <paper-material>graph data</paper-material>
                     <polyana-dashboard dashboard="[[dashboard]]" datasources="[[datasources]]" replace-targets="[[replaceTargets]]"></polyana-dashboard>
                </div>
            </paper-material>-->
            <paper-material class="info-card">
                <h2 style$="color:#fff;background-color: [[section.color]];">Basic Info</h2>
                <div class="card-content">
                    <table class="info-table">
                        <template is="dom-if" if="[[machine.public_ips]]">
                            <tr>
                                <td>Machine ID</td>
                                <td>[[machine.id]]</td>
                            </tr>
                            <tr>
                                <td>UUID</td>
                                <td>[[machine.uuid]]</td>
                            </tr>
                            <tr><td>Public IPs</td>
                                <td><template is="dom-repeat" items="[[machine.public_ips]]">
                                        [[item]]
                                    </template>
                                </td>
                            </tr>
                            <tr><td>Private IPs</td>
                                <td><template is="dom-repeat" items="[[machine.private_ips]]">
                                        [[item]]
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
            </paper-material>
            <paper-material class="info-card">
                <h2 style$="color:#fff;background-color: [[section.color]];">More Info</h2>
                <div class="card-content">
                    <element-for-in content="[[machine.extra]]"></element-for-in>
                </div>
            </paper-material>
        </div>
        <dialog-element id="machinedialog"></dialog-element>
        <!-- <associate-key keys=[[model.keysArray]] cloud-id="[[machine.cloud.id]]" machine-id="[[machine.id]]" host="[[machineIp]]"></associate-key> -->
        <!-- <iron-ajax id="actionRequest" url="/api/v1/clouds/[[machine.cloud.id]]/machines/[[machine.id]]" method="POST" on-response="_actionResponse" on-error="_actionError" on-request="_actionRequest"></iron-ajax> -->
        <iron-ajax id="machineDeleteAjaxRequest" url="/api/v1/machines/[[machine.id]]" method="DELETE" on-response="_handleMachineDeleteAjaxResponse" on-error="_handleMachineDeleteAjaxError"></iron-ajax>
        <iron-ajax id="disassociateKeyRequest" url="/api/v1/clouds/[[machine.cloud.id]]/machines/[[machine.id]]/keys/[[disassociateKeyId]]" method="DELETE" on-response="_disassociateKeyResponse" on-error="_disassociateKeyError" on-request="_disassociateKeyRequest"></iron-ajax>
        <!-- <machine-edit machine="[[machine]]"></machine-edit> -->
        <tags-list model="[[model]]"></tags-list>
        <paper-toast></paper-toast>
    </template>
</dom-module>
<script>
MACHINEACTIONS = {
  'shell': {
    'name': 'shell',
    'icon': 'vaadin-icons:terminal',
    'confirm': false,
    'multi': true
  },
  'tag': {
    'name': 'tag',
    'icon': 'label',
    'confirm': true,
    'multi': true
  },
  'run-script': {
    'name': 'run script',
    'icon': 'image:movie-creation',
    'confirm': true,
    'multi': false
  },
  'associate-key': {
    'name': 'associate key',
    'icon': 'communication:vpn-key',
    'confirm': true,
    'multi': true
  },
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'rename': {
    'name': 'rename',
    'icon': 'editor:mode-edit',
    'confirm': true,
    'multi': false
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  }
}
    Polymer({
        is: 'machine-page',

        properties: {
            model: {
                type: Object,
                notify: true
            },
            router: Object,
            params: {
                type: Object,
                notify: true
            },
            machine: {
                type: Object,
                computed: '_computeMachine(params, model.machinesArray.*)'
            },
            sections: {
                type: Array,
                notify: true
            },
            section: {
                type: Object
            },
            tag: {
                type: String,
                value: ""
            },
            isMonitored: {
                type: Boolean,
                value: true,
                notify: true
            },
            machineImage: {
                type: String,
                computed: "_machineImage(machine.imageId)"
            },
            dashboard: {
                type: Object
            },
            replaceTargets: {
                type: Object,
                computed: '_computeReplaceTargets(machine)'
            },
            isLoading: {
                type: Boolean,
                computed: '_computeIsloading(machine)',
                value: true
            },
            associatedKeys: {
                type: Array,
                computed:'_computeAssociatedKeys(machine, model.keysArray)'
            },
            newKeyId: {
                type: String,
                value: ''
            },
            machineIp: {
                type: String,
                computed: 'computeMachineIp(machine.public_ips)'
            },
            disassociateKeyId: {
                type: String
            },
            isPendingKeyRequest: {
                type: Boolean
            },
            hideAssociatedKeys: {
                type: Boolean
            },
            itemInArray: {
                type: Array,
                computed: '_computeItemInArray(machine)'
            },
            itemUid: {
                type: Array,
                computed: '_computeThisItemUid(machine)'
            },
            actions: {
                type: Array,
                computed: '_computeActions(machine)'
            }
        },
        observers: [
            '_isMonitored(machine, model.monitoring.machines.*)',
            '_computeHideAssociatedKeys(params, associatedKeys.*, isPendingKeyRequest)'
        ],
        listeners: {
            'confirmation': '_machineActionConfirmation',
            'pending-key-request': '_updateKeyLoader',
            'run-script-request':'_feedbackOnScript',
            'rename-request':'_feedbackOnRename'
        },
        ready: function(){
            this.set('hideAssociatedKeys', true);
            this.set('isPendingKeyRequest', false);
        },
        attached: function(){
            this.datasources = [
              {
              "id": 1,
              "orgId": 1,
              "name": "mistphite",
              "type": "graphite",
              "access": "proxy",
              "uri": "/graphite/",
              "password": "",
              "user": "",
              "database": "",
              "basicAuth": false,
              "basicAuthUser": "",
              "basicAuthPassword": "",
              "withCredentials": false,
              "isDefault": false,
              "jsonData": null
              }
            ];
            var that = this;
            setInterval(function(){ // FIXME: find a better way to fix broken chart width when coming from another page
                if (that.querySelector('dashboard-panel'))
                    that.querySelector('dashboard-panel').resize();

            }, 5000);

        },
        _computeActions: function(item){
            var ret = [];
            if (item.state == 'running') {
              // if key then add shell / run script
              // if not monitoring then enable monitoring
              ret.push('shell');
              ret.push('associate-key');
              if(this.hideAssociatedKeys)
                ret.push('run-script');
            }
            if (item.can_tag)
                ret.push('tag');
            if (item.can_start)
                ret.push('start');
            if (item.can_stop)
                ret.push('stop');
            if (item.can_suspend)
                ret.push('suspend');
            if (item.can_reboot)
                ret.push('reboot');
            if (item.can_resume)
                ret.push('resume');
            if (item.can_rename)
                ret.push('rename');
            if (item.can_destroy)
                ret.push('destroy');
            if (item.can_undefine)
                ret.push('undefine');

            var actions = [];
            for (var i=0; i<ret.length; i++) {
                actions.push(MACHINEACTIONS[ret[i]]);
            }

            return actions;
        },
        _computeMachine: function(params, machines) {
            this.dashboard = {
              "id": 1,
              "refresh": "10s",
              "rows": [{
                "panels": [{
                  "aliasColors": {},
                  "datasource": "mistphite",
                  "id": 2,
                  "span": 12,
                  "stack": false,
                  "targets": [
                    {
                    "refId": "A",
                    "target": "bucky."+params.uuid+".load.shortterm"
                    },
                  ],
                  "timeFrom": null,
                  "timeShift": null,
                  "title": "Load",
                  "type": "graph",
                  "x-axis": true,
                  "y-axis": true
                }],
              }],
              "time": {
                "from": "now-10m",
                "to": "now"
              },
              "timepicker": {
                "now": true,
                "refresh_intervals": [],
                "time_options": [
                  "5m",
                  "15m",
                  "1h",
                  "6h",
                  "12h",
                  "24h",
                  "2d",
                  "7d",
                  "30d"
                ]
              },
              "timezone": "browser"
            };

            if (this.machine && this.machine.uuid && params.uuid != this.machine.uuid) {
                this.set('isPendingKeyRequest', false);
            }
            return machines.base.find(function(machine) {
                return machine.uuid == params.uuid;
            }, this);
        },
        _computeItemInArray: function(){
            var arr = [];
            arr.push(this.machine);
            return arr;
        },
        _computeThisItemUid: function(machine){
            var itemUidInArray = [];
            itemUidInArray.push(itemUid(this.machine, this.sections['machines']));
            return itemUidInArray;
        },
        _computeAssociatedKeys: function(machine, keys){
            return machine.keys || [];
        },
        computeMachineIp: function(machineips){
            if (this.machine.public_ips){
                return this.machine.public_ips[0]
            }
            else {
                return ''
            }
        },
        _isEqual: function(a, b) {
            return a === b;
        },
        _isMonitored: function(machine, machines){
            if (machines){
                var mach =  machines.base.find(function(m){
                    return m[1] == machine.id ;
                }, this);
            }
            if (mach){
                this.isMonitored = true;
            }
            else{
                this.isMonitored = false;
            }
        },
        _machineImage: function(id) {
            var image = this.model.imagesArray.find(function(image) {
                return image.id == id;
            }, this);
            if (image)
                return image.name;
            else
                return "";
        },    
        _computeReplaceTargets: function(machine) {
            var ret = {'bucky.': ''};
            var m = this.machine;
            var mId = this.machine.id;
            var m = this.machine.name;
            ret[mId] = m ? m.name : 'unknown';
            // Object {bucky.: "", 3e3a36a5a2694f859a2dc2ccbc192619: "unknown", a203e912f9e744df8ac10179403b8248: "monitor-docker"}
            this.dashboard.rows[0].panels[0].targets[0].target = 'bucky.'+this.machine.id+'.load.shortterm';
            return ret;
        },
        confirmAction: function(action){
            this._showDialog({
                title: action+' Machine?',
                body: "You are about to "+ action +" machine '" + this.machine.name + "'.",
                danger: false,
                reason: "machine."+action,
                action: action
            });
        },
        _showDialog: function(info) {
            var dialog = this.querySelector('#machinedialog');
            for (var i in info) {
                dialog[i] = info[i];
            }
            dialog._openDialog();
        },
        _showToast: function(msg) {
            var toast = this.querySelector('paper-toast');
            toast.text = msg;
            toast.show();
        },
        isState: function(machine){
            return machine.state == machine.extra.status ;
        },
        _computeIsloading: function(machine) {
            return !this.machine ? true : false;
        },
        disassociateKey: function(e){
            var keyId = e.target['dataKeyid'];
            var keyName = e.target['dataKeyname'];

            console.log('disassociateKey',keyId, keyName);

            this.set('disassociateKeyId', keyId);
            
            console.log(this.disassociateKeyId);

            this._showDialog({
                title: 'Disassociate key',
                body: "You are about to disassociate key '" + keyName + "' from machine.",
                danger: false,
                reason: "disassociate.key",
                action: 'disassociate',
                key: keyId
            });
        },
        _disassociateKeyRequest: function(e){
            this.set('isPendingKeyRequest', true);
        },
        _disassociateKeyResponse: function(e){
            this.set('isPendingKeyRequest', false);
        },
        _disassociateKeyError: function(e){
            this.set('isPendingKeyRequest', false);
        },
        _updateKeyLoader: function(e){
            //console.log(e.detail);
            if (e.detail.request) {
                this.set('isPendingKeyRequest', true);
            }
            else if (e.detail.response) {
                this.set('isPendingKeyRequest', false);
            }
            else if (e.detail.error) {
                this.set('isPendingKeyRequest', false);
                this._showToast(e.detail.errormsg);
            }
        },
        _computeHideAssociatedKeys: function(machine, associatedKeys, isPendingKeyRequest){
            var hide =  !(this.machine.keys.length > 0 || isPendingKeyRequest);
            this.set('hideAssociatedKeys', hide);
        },
        _feedbackOnScript: function(e){
            if (e.detail.response) {
                this._showToast('Script run request succeded. Script '+this.model.scripts[e.detail.scriptId].name+' has been queued for execution');
            }
            if (e.detail.error) {
                this._showToast(e.detail.errormsg);
            }
        },
        _feedbackOnRename: function(e){
        console.log("_feedbackOnRename")
        if (e.detail.request) {
            this._showToast('Rename request sent. Waiting for machine to respond');
        }
        if (e.detail.response) {
            this._showToast('Renaming was successful.');
        }
        if (e.detail.error) {
            this._showToast(e.detail.errormsg);
        }
    },
    });
</script>
