<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="rules-item">
    <template>
        <style is="custom-style" include="shared-styles"></style>
        <style is="custom-style" include="forms"></style>
        <style is="custom-style">
        	:host {
                display: block;
            }
            .rule {
                padding: 8px 0;
            }
            .strong {
                font-weight: 500;
            }
            .rule-item {
            	padding-right: 24px;
            	padding-left: 24px;
            	align-items: center;
            	border-bottom: 1px solid #ccc;
            }
            .rule-item iron-icon[icon='close'] {
                cursor: pointer;
            }
            .rule-item iron-icon[icon='icons:warning'] {
                cursor: inherit;
                color: var(--red-color);
            }
            paper-icon-button::content iron-icon {
            	opacity: 0.32;
            }
            .rule-edit {
            	position: relative;
            	background-color: #eee;
            	padding: 0 24px 16px 24px;
            }
            .metricOp  {
                width: 50px;
            }
            .metricAggr,
            .metricAction {
                width: 100px;
            }
            paper-input#metricValue, 
            paper-input#metricOffset {
                width: 40px;
                display: inline-block;
            }
            paper-input#metricAggr {
                width: 120px;
                display: inline-block;
            }
            .rule.incident-true {
                color: var(--red-color);
            }
            .rule-actions {
            	align-self: flex-end;
            	justify-content: flex-end;
    			font-size: 0.9em;
            }
            .rule-id {
            	color: rgba(0,0,0,0.32);
            	font-size: 0.8em;
            }
            .rule-edit .rule-id {
            	position: absolute;
            	top: 16px;
            	left: 24px;
            }
        </style>

		<div class="rule-item layout horizontal"  hidden$="{{editMode}}">
            <div id="[[rule.id]]" class$="rule flex incident-[[ruleCreatesIncident(rule,incidents)]]">
                <span class="rule-id">[[rule.id]]</span>
                <iron-icon icon="icons:warning" hidden$="{{!ruleCreatesIncident(rule,incidents)}}"></iron-icon>
                If 
                <span class="strong">
                	[[computeName(rule.metric)]] [[computeOperator(rule.operator)]] [[rule.value]][[computeUnits(rule.metric)]] 
                </span>
                for [[computeAggregate(rule.aggregate)]] value 
                <span hidden$="[[!rule.aggregate]]">
                    within [[computeTime(rule.reminder_offset)]]min, 
                </span>then <span class="strong">[[rule.action]]</span>
            	<paper-icon-button icon="icons:create" toggles active={{editMode}}>edit</paper-icon-button>
            </div>
            <iron-icon icon="close" data-attr="[[rule.id]]" on-tap="deleteRule"></iron-icon>
        </div>
        <div class="rule-edit" hidden$="{{!editMode}}">
            <span class="rule-id">[[rule.id]]</span>
            <div id="[[rule.id]]" class="rule">
	            If 
	            <paper-dropdown-menu class="dropdown-block metricName">
	                <paper-menu id="metricName" attr-for-selected="value" selected="{{rule.metric}}" class="dropdown-content">
	                    <template is="dom-repeat" items="[[availableMterics]]" as="option">
	                        <paper-item value="[[option.id]]">[[option.name]]</paper-item>
	                    </template>
	                </paper-menu>
	            </paper-dropdown-menu>

	            <paper-dropdown-menu class="dropdown-block metricOp">
	                <paper-menu id="metricOp" attr-for-selected="value" selected="{{rule.operator}}" class="dropdown-content">
	                    <paper-item value="gt"> > </paper-item>
	                    <paper-item value="lt"> < </paper-item>
	                </paper-menu>
	            </paper-dropdown-menu>

	            <paper-input id="metricValue" placeholder="5" value="{{rule.value}}" auto-validate></paper-input>

	            {{computeUnits(newMetric)}}

	            for 

	            <paper-dropdown-menu class="dropdown-block metricAggr">
	                <paper-menu id="metricAggr" attr-for-selected="value" selected="{{rule.aggregate}}" class="dropdown-content">
	                    <paper-item value="all"> every </paper-item>
	                    <paper-item value="any"> any </paper-item>
	                    <paper-item value="avg"> average </paper-item>
	                </paper-menu>
	            </paper-dropdown-menu>

	            value within 

	            <paper-input id="metricOffset" placeholder="1" value="{{rule.reminder_offset}}" auto-validate></paper-input>min,

	            then

	            <paper-dropdown-menu class="dropdown-block metricAction">
	                <paper-menu id="metricAction" attr-for-selected="value" selected="{{rule.action}}" class="dropdown-content">
	                    <paper-item value="alert"> alert </paper-item>
	                    <paper-item value="reboot"> reboot </paper-item>
	                    <paper-item value="destroy"> destroy </paper-item>
	                    <paper-item value="command"> command </paper-item>
	                    <paper-item value="launch" disabled> launch </paper-item>
	                </paper-menu>
	            </paper-dropdown-menu>
            </div>
            <div class="rule-actions layout horizontal">
            	<paper-button toggles active={{!editMode}}>cancel</paper-button>
            	<paper-button on-tap="updateRule" class="blue">upadate rule</paper-button>
            </div>
        </div>
        <iron-ajax id="deleteRuleRequest" contentType="application/json" handle-as="json" method="DELETE" on-request="_handleDeleteRequest" on-response="_handleDeleteResponse" on-error="_handleDeleteError"></iron-ajax>

        <iron-ajax id="addRuleRequest" url="/api/v1/rules" contentType="application/json" handle-as="json" method="POST" on-request="_handleAddRequest" on-response="_handleAddResponse" on-error="_handleAddError"></iron-ajax>

        <!-- get metrics: http://localhost/api/v1/clouds/[[cloud.id]]/machines/[[machine.id]]/metrics -->
    </template>

    <script>
        Polymer({
            is: 'rules-item',

            properties: {
                incidents: {
                    type: Array,
                    notify: true
                },
                resource: Object,  // machine, cloud or other later
                rule: Object,
                items: {
                    type: Array,
                    computed: "_computeRules(rules)",
                    notify: true
                },
                availableMterics: {
                    type: Array,
                    computed: "_computeMetrics(resource)"
                },
            },
            listeners: {
            },
            observers: [
            ],
            ready: function() {
            },
            computeUnits: function(metric) {
                return DEFAULT_METRICS[metric] ? DEFAULT_METRICS[metric].unit : 'unit';
            },
            computeName: function(metric) {
                return DEFAULT_METRICS[metric]? DEFAULT_METRICS[metric].name : 'name';
            },
            computeTime: function(time){
                return time/60 + 1;
            },
            computeOperator: function(op){
                if (op == "gt")
                    return ">";
                if (op == "lt")
                    return "<";
            },
            computeAggregate: function(aggr){
                if (aggr == "all")
                    return "every";
                else
                    return aggr;
            },
            ruleCreatesIncident: function(rule, incidents){
                var find = false;
                    find = this.incidents.find(function(i){
                    return !i.finished_at && i.rule_id == rule.id;
                });
                return !find ? false : true;
            },
            _computeMetrics: function(machine){
                var metrics = [];
                for (var p in DEFAULT_METRICS){
                    metrics.push(DEFAULT_METRICS[p])
                }
                return metrics;
            },
            deleteRule: function(e){
                var ruleid = e.target.dataAttr;
                this.$.deleteRuleRequest.url = '/api/v1/rules/'+ruleid;
                this.$.deleteRuleRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.deleteRuleRequest.generateRequest();
            },
            
        });
DEFAULT_METRICS = {
    "cpu.total.nonidle": {
        "_target": "asPercent(sumSeries(exclude(%(head)s.cpu.*.*,'idle')),sumSeries( % (head) s.cpu.*.*))",
        "max_value": 100,
        "min_value": 0,
        "priority": -50,
        "id": "cpu.total.nonidle",
        "unit": "%",
        "name": "CPU"
    },
    "load.longterm": {
        "_target": "%(head)s.load.longterm",
        "max_value": null,
        "min_value": 0,
        "priority": 0,
        "id": "load.longterm",
        "unit": "",
        "name": "Load (15 mins)"
    },
    "load.midterm": {
        "_target": "%(head)s.load.midterm",
        "max_value": null,
        "min_value": 0,
        "priority": 0,
        "id": "load.midterm",
        "unit": "",
        "name": "Load (5 mins)"
    },
    "load.shortterm": {
        "_target": "%(head)s.load.shortterm",
        "max_value": null,
        "min_value": 0,
        "priority": -50,
        "id": "load.shortterm",
        "unit": "",
        "name": "Load"
    },
    "memory.used_percent": {
        "_target": "asPercent(%(head)s.memory.used,sumSeries( % (head) s.memory.*))",
        "max_value": 100,
        "min_value": 0,
        "priority": 0,
        "id": "memory.used_percent",
        "unit": "%",
        "name": "RAM used"
    },
    "memory.nonfree_percent": {
        "_target": "asPercent(sumSeries(exclude(%(head)s.memory.*,'free')),sumSeries( % (head) s.memory.*))",
        "max_value": 100,
        "min_value": 0,
        "priority": -50,
        "id": "memory.nonfree_percent",
        "unit": "%",
        "name": "RAM"
    },
}
    </script>
</dom-module>
