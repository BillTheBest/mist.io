<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<dom-module id="app-incidents">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            display: block;
            transition: var(--material-curve-320);
            transform: translate(0, 60px);
            opacity: 0;
        }

        :host(.active) {
            transform: translate(0, 0);
            opacity: 1;
        }

        :host paper-material {
            min-width: 50%;
        }

        h3 {
            text-transform: uppercase;
            font-size: 13px;
            color: rgba(0, 0, 0, 0.54);
            padding: 0 10px;
            border-bottom: 1px solid #eee;
        }

        .list-item {
            border-bottom: 1px solid #eee;
            padding: 10px;
        }

        .list-item.red {
            background-color: #D96557;
            color: #fff;
        }

        .list-item.red .expression > iron-icon {
            color: #fff;
        }

        .list-item.green .expression > iron-icon {
            color: green;
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .block {
            transform: translate(0, 50px);
            opacity: 0;
            transition: all 500ms 320ms;
            transition-timing-function: var(--material-curve-320);
        }

        :host(.active) .block {
            transform: translate(0, 0);
            opacity: 1;
        }

        @media (min-width: 869px) {
            .content-area {
                max-height: 390px;
                overflow-y: scroll;
            }
        }

        span.rule-condition {
            font-weight: normal;
        }

        span.time {
            float: right;
        }
        </style>
        <paper-material>
            <!-- title goes here, should change on stateChanged-->
            <h2 class="app-title">{{title}}</h2>
            <div class="content-area">
                <content></content>
                <div class="block">
                    <template is="dom-repeat" items="[[model.incidents]]">
                        <a class$="list-item layout horizontal wrap [[incidentColor(item)]]" href$="[[machineUri(item)]]">
                            <div class="flexchild expression">
                                <iron-icon icon="[[incidentIcon(item)]]"></iron-icon>
                                <span class="machine">[[machineName(item)]]</span>: <span class="rule-condition">[[ruleCondition(item)]]</span>
                                <span class="time">
                                    <template is="dom-if" if="!item.finished_at">
                                        <sc-timeago datetime="[[incidentDuration(item)]]"></sc-timeago>
                                    </template>
                                    [[incidentTime(item)]]
                                </span>
                            </div>
                            <div>
                                <iron-icon icon="hardware:keyboard-arrow-right"></iron-icon>
                            </div>
                        </a>
                    </template>
                </div>
                <!-- state MIDDLE : urge user to add rules -->
                <!-- state ONBOARD : urge user to add machine monitoring -->
            </div>
        </paper-material>
    </template>
</dom-module>
<script>
Polymer({
    is: 'app-incidents',
    properties: {
        title: {
            String, value: "Incidents"
        },
        model: {
            type: Object
        },
        state: {
            String, value: "ONBOARD"
        },
        whatTriggeredIt: {
            String, value: "#"
        }, // whatTriggeredIt will be func(machine,rule) to find url#anchore to the machine page and specific rule that trigered the alert
        alertstateclass: {
            String, value: "red"
        } // alert > red, resolved > green
    },
    stateChanged: function(newstate) {
        //newstate ONBOARD > title Welcome
        //newstate MIDDLE > title Add your rules
        //newstate FULL > title Incidents
        //default > title Incidents
    },
    attached: function() {
        var rows = this.parentNode.querySelectorAll('block');
        var index = Array.prototype.indexOf.call(rows, this);
        setTimeout(function() {
            this.classList.add('active');
        }.bind(this), (index + 1) * 50);
    },
    incidentColor: function(item){
        if (!item.finished_at)
            return 'red';
        return 'green';
    },
    incidentIcon: function(item) {
        if (!item.finished_at)
            return 'icons:report-problem';
        return 'icons:check';
    },
    machineName: function(item) {
        if (item.logs.length)
            return item.logs[0].machine_name;
        return this.model.clouds[item.cloud_id].machines[item.machine_id].name;
    },
    machineUri: function(item) {
        console.log(this.model.clouds, item.cloud_id, this.model.incidents, this.model.monitoring);
        return '/machines/'  + item.machine_id;
    },
    ruleCondition: function(item) {
        return item.logs.length && item.logs[0].condition;
    },
    incidentDuration: function(item) {
        if (!item.finished_at)
            return new Date(item.started_at*1000)
        return new Date(item.started_at*1000)
        //return Date.now()-(item.finished_at-item.started_at)*1000;
    },
    incidentTime: function(item) {
        if (!item.finished_at)
            return 'for '
        return ''
    }
});
</script>
