<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<dom-module id="details-page">
    <template>
        <style is="custom-style" include="forms"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }

            :host paper-material {
                display: block;
                padding: 0;
            }

            label {
                color: rgba(0, 0, 0, 0.54) !important;
                font-size: 12px;
            }

            .grid-row {
                padding: 24px;
            }

            .head {
                margin-bottom: 16px;
            }

            h2.title {
                font-weight: 500;
            }

            h2.title, h2.title~p {
                margin-top: 0;
                margin-bottom: 0;
            }

            paper-radio-button {
                --paper-radio-button-checked-color: var(--paper-light-blue-500);
                --paper-radio-button-checked-ink-color: var(--paper-light-blue-500);
                --paper-radio-button-unchecked-ink-color: var(--paper-light-blue-900);
            }
            hr {
                width: 100%;
            }
            paper-progress#orgProgress,
            paper-progress#userProgress {
                position: absolute;
                width: 100%;
                left: 0;
                right: 0;
            }

            .bottom-actions {
                padding-bottom: 24px;
                padding-left: 1rem;
            }
            .separator {
                border-top: 4px solid #ddd;
            }
            .progress {
                margin: 32px 0 8px 0;
                width: 100%;
            }
            paper-progress.progresserror ::content #primaryProgress {
                background-color: var(--red-color);
            }
            .errormsg-container {
                color: var(--red-color);
                padding-left: 24px;
                padding-right: 24px
            }
            .errormsg-container iron-icon {
                color: inherit;
            }
        </style>
        <paper-material>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">User Profile</h2>
                    <p>Enter your name and email.</p>
                </div>
                <paper-input class="xs12 l6" id="firstName" label="First Name" required error-message="Please enter your first name" value="{{firstName}}" auto-validate></paper-input>

                <paper-input class="xs12 l6" id="lastName" label="Last Name" required error-message="Please enter your last name" value="{{lastName}}" auto-validate></paper-input>

                <paper-input class="xs12 l6" id="email" label="Email *" required error-message="Please enter your email" value="[[user.email]]" auto-validate disabled></paper-input>
                <p class="xs12 l12">* Currently you cannot change your account's email for security reasons. Please contact us at <a href="mailto:support@mist.io">support@mist.io</a>, if you wish to do so.</p>

                <div class="progress">
                    <paper-progress id="userProgress" indeterminate hidden$="[[!loadingUser]]"></paper-progress>
                    <paper-progress id="userprogresserror" class="progresserror" value="100" hidden$="[[!userError]]"></paper-progress>
                    <hr class="appform"/>
                    <p id="userprogressmessage" class="errormsg-container" hidden$="[[!userError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="usererrormsg"></span></p>
                </div>

                <div class="bottom-actions clearfix xs12">
                    <paper-button class="pull-right" disabled$="[[!userFormReady]]" raised on-tap="_submitUserForm" page="second">Save User Profile</paper-button>
                    <iron-ajax id="userAjaxRequest"
                        url="/api/v1/account"
                        method="POST"
                        loading="{{loadingUser}}"
                        on-response="_handleAjaxResponse"
                        on-error="_handleDetailsAjaxError"
                        handle-as="xml"></iron-ajax>
                </div>
            </div>

        </paper-material>
        <paper-material class="separator">

            <div class="grid-row" hidden$="[[!org.is_owner]]">
                <div class="xs12 head">
                    <h2 class="title">Organisation Profile</h2>
                    <p>Enter your organisation details. To switch organisation use the  user menu in the top right corner of your screen.</p>
                </div>
                <paper-input class="dropdown-block xs12 l6" id="orgName" label="Organization Name" required error-message="Please enter your company's name" value="{{orgName}}" auto-validate disabled$="[[!org.is_owner]]"></paper-input>
                
                <!-- <paper-input class="xs12 l6" id="org-email" label="Organisation Alert Email *" error-message="Please enter your email" value="[[org.email]]" auto-validate></paper-input>

                <p class="xs12 l12">* In your organisation's alert email, you can specify the email you want your incidents' alerts to be sent to. This can be overriden when you add rules in your monitored machines.</p> -->

                <div class="progress">
                    <paper-progress id="orgProgress" indeterminate hidden$="[[!loadingOrg]]"></paper-progress>
                    <paper-progress id="orgprogresserror" class="progresserror" value="100" hidden$="[[!orgError]]"></paper-progress>
                    <hr class="appform"/>
                    <p id="orgprogressmessage" class="errormsg-container" hidden$="[[!orgError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="orgerrormsg"></span></p>
                </div>

                <div class="bottom-actions clearfix xs12">
                    <paper-button class="pull-right" disabled$="[[!orgFormReady]]" raised on-tap="_submitOrgForm" page="second">Save Organisation Profile</paper-button>
                    <iron-ajax id="orgAjaxRequest"
                        url="/api/v1/org/[[org.id]]"
                        method="PUT"
                        loading="{{loadingOrg}}"
                        on-response="_handleAjaxResponse"
                        on-error="_handleOrgAjaxError"
                        handle-as="xml"></iron-ajax>
                </div>
            </div>

            <div class="grid-row" hidden$="[[org.is_owner]]">
              <div class="xs12 head">
                  <h2 class="title">Organisation</h2>
                  <p>You are operating as a member of <strong>[[org.name]]</strong>. To switch between organisations use the user menu in the top right corner of your screen.</p>
              </div>
            </div>

        </paper-material>
    </template>
    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'details-page',

                properties: {
                    org: {
                        type: Object
                    },
                    user: {
                        type: Object,
                    },
                    firstName: {
                        type: String
                    },
                    lastName: {
                        type: String
                    },
                    orgName: {
                        type: String
                    },
                    userFormReady: {
                        type: Boolean,
                        computed: '_computeUserFormReady(firstName, lastName, loadingUser, user)'
                    },
                    orgFormReady: {
                        type: Boolean,
                        computed: '_computeOrgFormReady(orgName, loadingOrg, org)'
                    },
                    loadingUser: {
                        type: Boolean,
                        value: false
                    },
                    userError: {
                        type: Boolean,
                        value: false
                    },
                    loadingOrg: {
                        type: Boolean,
                        value: false
                    },
                    orgError: {
                        type: Boolean,
                        value: false
                    }

                },
                observers: [
                    '_userUpdated(user)',
                    '_orgUpdated(org)'
                ],

                _userUpdated: function(user) {
                    this.firstName = user.first_name;
                    this.lastName = user.last_name;
                },

                _orgUpdated: function(org) {
                    this.orgName = org.name;
                },

                _computeUserFormReady: function(firstName, lastName, loading, user) {
                    if (loading || !user)
                        return false;

                    if (firstName == user.first_name && lastName == user.last_name)
                        return false;

                    if (firstName && lastName)
                        return true;

                    return false;
                },

                _computeOrgFormReady: function(orgName, loading, org){
                    if (orgName && orgName != org.name && orgName.trim() != "" && org.is_owner && !loading)
                        return true;
                    return false;
                },

                _computeShowProgress: function(sendingData) {
                    return sendingData;
                },

                _submitUserForm: function(e, user) {
                    var payload = {
                        action: 'update_details',
                        first_name: this.firstName,
                        last_name: this.lastName
                    };

                    this.$.userAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.userAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.userAjaxRequest.body = payload;
                    this.$.userAjaxRequest.generateRequest();
                    console.log('loadingUser', this.loadingUser);
                },

                _submitOrgForm: function(e, org) {
                    var payload = {
                        new_name: this.orgName
                    };

                    this.$.orgAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.orgAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.orgAjaxRequest.body = payload;
                    this.$.orgAjaxRequest.generateRequest();
                    console.log('loadingOrg', this.loadingOrg);
                },

                _handleAjaxResponse: function(e) {
                    document.querySelector('paper-toast#mist-toast').show({text: 'Changes saved succesfully!'})
                },

                _handleAjaxError: function() {
                    this.set('userError', true);
                    this.$.usererrormsg.textContent = e.detail.request.xhr.responseText;
                },
                _handleOrgAjaxError: function(e) {
                    this.set('orgError', true);
                    this.$.orgerrormsg.textContent = e.detail.request.xhr.responseText;
                }
            });
        })();
    </script>
</dom-module>
