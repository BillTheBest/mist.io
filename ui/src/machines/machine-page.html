<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../helpers/dialog-element.html">
<link rel="import" href="../tags/tags-list.html">
<link rel="import" href="../item-list/item-actions.html">
<link rel="import" href="../element-for-in/element-for-in.html">
<link rel="import" href="../mist-rules/mist-rules.html">
<link rel="import" href="../mist-monitoring.html">

<link rel="import" href="machine-edit.html">

<dom-module id="machine-page">
    <template>
        <style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="info-table-style"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }
            .columns {
                @apply(--layout-horizontal);
                flex: 1 100%;
                margin-bottom: 16px;
            }
            .columns paper-material > .break {
                word-break: break-all;
            }
            .left {
                line-height: 1.6em;
            }
            .left, .right {
                @apply(--layout-vertical);
                align-items: flex-start;
                flex-direction: column;
                flex: 1 100%;
            }
            .left h3, .right h3 {
                margin-bottom: 0;
            }
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
                align-content: stretch;
                flex: 100%;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .paper-header h2 {
                @apply(--layout-flex-none);
            }

            .machine-ip {
                margin: 0;
            }

            paper-material {
                padding: 24px;
                box-sizing: border-box;
                width: 100%;
            }
            paper-material.info-card {
                padding: 0;
            }
            paper-material > h2 {
                line-height: initial !important;
                margin-bottom: 0;
                cursor: pointer;
            }

            .subhead {
                box-sizing: border-box;
                position: absolute;
                width: 100%;
                left: 0;
                height: 57px;
                bottom: -57px;
                right: 0;
                z-index: 9;
                color: rgba(0, 0, 0, 0.87);
            }

            paper-header-panel::content #dropShadow {
                top: 56px;
            }

            paper-toolbar::content #bottomBar .right-actions {
                transition: var(--paper-toolbar-transition, margin-right 0.18s ease-in);
            }

            paper-toolbar:not(.tall)::content #bottomBar .right-actions {
                margin-right: 70px;
            }

            .label {
                padding: 2px !important;
            }

            #machine_actions paper-button {
                text-align: left !important;
            }
            .machine-state-icon {
                background-color: #fff !important;
            }
            .machine-state-icon.running {
                color: var(--green-color) !important;
            }

            .machine-state-icon.terminated {
                color: var(--mist-dark-color) !important;
            }

            .machine-state-icon.stopped {
                color: var(--orange-color) !important;
            }

            .machine-state-icon.error {
                color: var(--red-color) !important;
            }

            .machine-state-icon.unknown, .machine-state-icon.pending {
                color: #ccc !important;
            }

            paper-material .smallcaps {
                margin-top: 0;
            }
            paper-material .tags-head {
                margin-bottom: 8px;
            }
            :host .tag {
                display: inline !important;
                padding: 4px;
                margin: 4px;
            }
            polyana-dashboard ::content h3 {
                text-transform: uppercase;
                font-size: 16px;
                font-weight: 500;
                line-height: 36px;
            }
            polyana-dashboard {
              display: block;
                height: auto;
                overflow: hidden;
            }
            paper-button[disabled] {
                opacity: 0.54
            }
            paper-button.left-icon iron-icon {
                margin: 0 4px 0 0;
            }
            paper-button.right-icon iron-icon {
                margin: 0 0 0 4px;
            }
            .machine-key {
                line-height: 24px;
                display: inline-block;
                vertical-align: top;
            }
            .machine-key iron-icon {
                margin-right: 8px;
                opacity: 0.32;
                cursor: pointer;
            }
            .machine-key iron-icon[icon='close'] {
                opacity: 0;
                margin-right: 16px;
            }
            .machine-key:hover iron-icon[icon='close'] {
                opacity: 0.32;
            }
            #pendingKeyrequest paper-spinner {
                width: 24px !important;
                height: 24px !important;
                vertical-align: middle !important;
            }
            .machine-actions > * {
                /*vertical-align: middle;*/
            }
            .machine-actions > paper-button.left-icon iron-icon {
                /*padding-right: 8px;*/
            }
            .machine-actions > paper-button.right-icon iron-icon {
                /*padding-left: 8px;*/
            }
            item-actions {
                display: flex;
                font-size: 1em;
            }
            item-actions ::content .actions {
                height: auto;
                display: flex;
                vertical-align: auto;
                padding: 0;
            }
            item-actions ::content .item-actions {
                margin-left: 0 !important;
            }
            .dc-true {
                color: #F57F17;
            }
            .dc-true iron-icon {
                color: inherit;
            }
            .dc-false {
                color: var(--green-color);
            }
            .probe-df {
                height: 240px;
                overflow-y: scroll;
            }
            .probe-data {
                position: relative;
            }
            .probe-data.hasprobe {
                overflow: visible;
            }
            .probe-data.hasprobe {
                height: 8px;
                width: 4px;
                display: inline-block;
                margin: 2px 8px;
            }
            /* midterm */
            .midlow {
                background: #42A5F5; /*cyan*/
            }
            .midmedium {
                background: #FFCA28; /*orange*/
            }
            .midhigh {
                background: #EF5350; /*red*/
            }
            .mideco {
                background: #69b46c; /*green*/
            }
            /* shortlow + long */
            .shortlow.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*cyan cyan*/
            }
            .shortlow.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*cyan orange*/
            }
            .shortlow.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #EF5350; /*cyan red*/
            }
            .shortlow.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #42A5F5, -1px 0 0 #fff, -4px 0 0 #69b46c; /*cyan green*/
            }
            /* shortmedium + long */
            .shortmedium.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*orange cyan*/
            }
            .shortmedium.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*orange orange*/
            }
            .shortmedium.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #EF5350; /*orange red*/
            }
            .shortmedium.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #FFCA28, -1px 0 0 #fff, -4px 0 0 #69b46c; /*cyan green*/
            }
            /* shorthigh + long */
            .shorthigh.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*red cyan*/
            }
            .shorthigh.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*red orange*/
            }
            .shorthigh.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #EF5350; /*red red*/
            }
            .shorthigh.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #EF5350, -1px 0 0 #fff, -4px 0 0 #69b46c; /*red green*/
            }
            /* shorteco + long */
            .shorteco.longlow {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #42A5F5; /*green cyan*/
            }
            .shorteco.longmedium {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #FFCA28; /*green orange*/
            }
            .shorteco.longhigh {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #EF5350; /*green red*/
            }
            .shorteco.longeco {
                box-shadow: 1px 0 0 #fff, 4px 0 0 #69b46c, -1px 0 0 #fff, -4px 0 0 #69b46c; /*green green*/
            }
        </style>

        <div id="content">
            <div class="is-loading" hidden$="[[!isLoading]]">
                <paper-spinner active hidden$="[[!isLoading]]"></paper-spinner>
            </div>
            <paper-material class="single-head layout horizontal" style$="color:#fff;background-color: [[section.color]];">
                <span class="icon"><iron-icon class$=" machine-state-icon [[machine.state]]" icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        [[machine.name]]
                    </h2>
                    <div class="subtitle">
                        [[machine.state]] <span class="desc" hidden$="[[isState(machine)]]">[[machine.extra.status]]</span>
                    </div>
                </div>
                <div class="machine-actions">
                    <item-actions id="actions" items="[[itemInArray]]" selected-items="[[itemUid]]" selected-item="[[machine]]" section="[[section]]" actions="[[actions]]" org="[[model.org]]" model="[[model]]"></item-actions>
                </div>
            </paper-material>
            <div class="columns">
                <paper-material id="leftcolumn" class="left">
                    <h3 class="smallcaps">Info:</h3>
                    <span hidden$="[[!machine.cloud.title]]">Cloud: [[machine.cloud.title]]</span>
                    <span hidden$="[[!machine.extra.image]]" class="break">Image: [[machine.extra.image]]</span>
                    <span hidden$="[[!machine.extra.created]]">Created: [[machine.extra.created]]</span>
                    <div hidden$="[[!probeData]]"> Probe Data:
                        <span class$="probe-data [[itemProbeClasses(machine, model.probes)]]"> </span>
                        <span hidden$="[[!probeData]]"> [[probeData]] </span> <br/>
                        <span hidden$="[[!lastProbe]]"> [[lastProbe]] </span>
                    </div>
                    <div hidden$="[[!kernelInfo]]">
                        [[kernelInfo]]
                    </div>
                    <div hidden$="[[!probeObj]]">
                        <span class$="dc-[[probeObj.dirty_cow]]" hidden$="[[probeObj.dirty_cow]]">
                            Dirty COW check passed.
                        </span>
                        <span class$="dc-[[probeObj.dirty_cow]]" hidden$="[[!probeObj.dirty_cow]]">
                            <iron-icon hidden$="[[!probeObj.dirty_cow]]" icon="icons:report-problem"></iron-icon> [[dirtyCowAlert]]
                        </span>
                        <!-- <a href="/link-to-blog" target="new" class="regular" hidden$="[[!probeObj.dirty_cow]]">read more...</a> -->
                    </div>
                </paper-material>
                <paper-material id="rightcolumn" class="right">
                    <div hidden$="[[!machine.keys.length]]">
                        <h3 class="smallcaps">Associated Keys:</h3>
                        <div class="associatedKeys">
                            <template is="dom-repeat" items="{{machine.keys}}">
                                <div class="machine-key">
                                    <a class="regular blue-link flexchild" href$="/keys/[[item.id]]"><iron-icon icon="communication:vpn-key"></iron-icon> [[item.name]]</a>
                                    <iron-icon data-keyid="[[item.id]]" data-keyname="[[item.name]]" icon="close" on-tap="disassociateKey"></iron-icon>
                                </div>
                            </template>
                            <div class="machine-key" id="pendingKeyRequest">
                                <paper-spinner active hidden$="[[!isPendingKeyRequest]]"></paper-spinner>
                            </div>
                        </div>
                    </div>
                    <div hidden$="[[!machine.tags.length]]">
                        <h3 class="smallcaps tags-head">TAGS:</h3>
                        <template is="dom-repeat" items="[[machine.tags]]">
                            <span class="tag">[[item.key]]<span hidden$="[[!item.value]]">=</span>[[item.value]]</span>
                        </template>
                    </div>
                </paper-material>
            </div>
            <paper-material class="info-card">
                <mist-monitoring resource="[[machine]]" monitoring="[[model.monitoring]]" section="[[section]]" datasources="[[datasources]]"></mist-monitoring>
                <mist-rules builtin-metrics="[[model.monitoring.builtin_metrics]]" incidents="[[model.incidentsArray]]" rules="[[model.monitoring.rules]]" resource="[[machine]]" user-email="[[model.user.email]]" hidden$="{{!isActivated}}"></mist-rules>
            </paper-material>
            <paper-material class="info-card">
                <h2 style$="color:#fff;background-color: [[section.color]];">Basic Info</h2>
                <div class="card-content">
                    <table class="info-table">
                        <template is="dom-if" if="[[machine.public_ips]]">
                            <tr>
                                <td>Machine ID</td>
                                <td>[[machine.id]]</td>
                            </tr>
                            <tr>
                                <td>UUID</td>
                                <td>[[machine.uuid]]</td>
                            </tr>
                            <tr><td>Public IPs</td>
                                <td><template is="dom-repeat" items="[[machine.public_ips]]">
                                        [[item]]
                                    </template>
                                </td>
                            </tr>
                            <tr>
                                <td>Private IPs</td>
                                <td><template is="dom-repeat" items="[[machine.private_ips]]">
                                        [[item]]
                                    </template>
                                </td>
                            </tr>
                            <tr hidden$="[[!probeObj]]">
                                <td>Users</td>
                                <td>[[probeObj.users]]</td>
                            </tr>
                            <tr hidden$="[[!probeObj]]">
                                <td>Uptime</td>
                                <td>[[probeObj.uptime]]</td>
                            </tr>
                            <tr hidden$="[[!probeData]]">
                                <td>Filesystem Info</td>
                                <td>
                                    <div class="probe-df">
<pre><code>[[probeObj.df]]</code></pre>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
            </paper-material>
            <paper-material class="info-card">
                <h2 style$="color:#fff;background-color: [[section.color]];">More Info</h2>
                <div class="card-content">
                    <element-for-in content="[[machine.extra]]"></element-for-in>
                </div>
            </paper-material>
        </div>
        <dialog-element id="machinedialog"></dialog-element>
        <!-- <associate-key keys=[[model.keysArray]] cloud-id="[[machine.cloud.id]]" machine-id="[[machine.id]]" host="[[machineIp]]"></associate-key> -->
        <!-- <iron-ajax id="actionRequest" url="/api/v1/clouds/[[machine.cloud.id]]/machines/[[machine.id]]" method="POST" on-response="_actionResponse" on-error="_actionError" on-request="_actionRequest"></iron-ajax> -->
        <iron-ajax id="machineDeleteAjaxRequest" url="/api/v1/machines/[[machine.id]]" method="DELETE" on-response="_handleMachineDeleteAjaxResponse" on-error="_handleMachineDeleteAjaxError"></iron-ajax>
        <iron-ajax id="disassociateKeyRequest" url="/api/v1/clouds/[[machine.cloud.id]]/machines/[[machine.id]]/keys/[[disassociateKeyId]]" method="DELETE" on-response="_disassociateKeyResponse" on-error="_disassociateKeyError" on-request="_disassociateKeyRequest"></iron-ajax>
        <machine-edit machine="[[machine]]"></machine-edit>
        <tags-list model="[[model]]"></tags-list>
        <paper-toast></paper-toast>
    </template>
</dom-module>
<script>
MACHINEACTIONS = {
  'shell': {
    'name': 'shell',
    'icon': 'vaadin-icons:terminal',
    'confirm': false,
    'multi': true
  },
  'tag': {
    'name': 'tag',
    'icon': 'label',
    'confirm': true,
    'multi': true
  },
  'run-script': {
    'name': 'run script',
    'icon': 'image:movie-creation',
    'confirm': true,
    'multi': false
  },
  'associate-key': {
    'name': 'associate key',
    'icon': 'communication:vpn-key',
    'confirm': true,
    'multi': true
  },
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'rename': {
    'name': 'rename',
    'icon': 'editor:mode-edit',
    'confirm': true,
    'multi': false
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  },
  'probe': {
    'name': 'probe',
    'icon': 'icons:compare-arrows',
    'confirm': false,
    'multi': true
  },
}

Polymer({
    is: 'machine-page',
    properties: {
        model: {
            type: Object,
            notify: true
        },
        router: Object,
        machine: Object,
        sections: {
            type: Array,
            notify: true
        },
        section: {
            type: Object
        },
        tag: {
            type: String,
            value: ""
        },
        isMonitored: {
            type: Boolean,
            value: false,
            notify: true
        },
        isActivated: {
            type: Boolean,
            value: false,
            computed: '_computeIsActivated(machine, model.monitoring.monitored_machines.*)'
        },
        machineImage: {
            type: String,
            computed: "_machineImage(machine.imageId)"
        },
        dashboard: {
            type: Object
        },
        isLoading: {
            type: Boolean,
            computed: '_computeIsloading(machine)',
            value: true
        },
        newKeyId: {
            type: String,
            value: ''
        },
        machineIp: {
            type: String,
            computed: 'computeMachineIp(machine, machine.public_ips)'
        },
        disassociateKeyId: {
            type: String
        },
        isPendingKeyRequest: {
            type: Boolean
        },
        hideAssociatedKeys: {
            type: Boolean
        },
        itemInArray: {
            type: Array,
            computed: '_computeItemInArray(machine)'
        },
        itemUid: {
            type: Array,
            computed: '_computeThisItemUid(machine)'
        },
        actions: {
            type: Array,
            computed: '_computeActions(machine)'
        },
        probeData: {
            type: String,
            computed: '_computeProbeData(machine, model.probes.*)',
            value: false
        },
        dirtyCowAlert: {
             type: String,
             computed: '_computeDirtyCowAlert(machine, model.probes.*)',
             value: false
         },
        probeObj: {
            type: Object,
            computed: '_computeProbeObj(machine, model.probes.*)',
            value: false
        }
    },
    observers: [
        '_isMonitored(machine, model.monitoring.machines.*)'
    ],
    listeners: {
        'confirmation': '_machineActionConfirmation',
        'pending-key-request': '_updateKeyLoader',
    },
    ready: function() {
        this.set('hideAssociatedKeys', true);
        this.set('isPendingKeyRequest', false);
    },
    attached: function() {
        this.datasources = [{
            "id": 1,
            "orgId": 1,
            "name": "mist.monitor",
            "type": "mist.monitor",
            "uri": "/api/v1/stats"
        }];
    },

    _computeActions: function(item) {
        var ret = [];
        if (item.state == 'running') {
            // if key then add shell / run script
            // if not monitoring then enable monitoring
            ret.push('shell');
            ret.push('associate-key');
            if(this.hideAssociatedKeys)
                ret.push('run-script');
        }
        if (item.can_tag)
            ret.push('tag');
        if (item.can_start)
            ret.push('start');
        if (item.can_stop)
            ret.push('stop');
        if (item.can_suspend)
            ret.push('suspend');
        if (item.can_reboot)
            ret.push('reboot');
        if (item.can_resume)
            ret.push('resume');
        if (item.can_rename)
            ret.push('rename');
        if (item.can_destroy)
            ret.push('destroy');
        if (item.can_undefine)
            ret.push('undefine');

        var actions = [];
        for (var i = 0; i < ret.length; i++) {
            actions.push(MACHINEACTIONS[ret[i]]);
        }

        return actions;
    },

    _computeItemInArray: function() {
        return [this.machine];
    },

    _computeThisItemUid: function(machine) {
        var itemUidInArray = [];
        itemUidInArray.push(itemUid(this.machine, this.sections['machines']));
        return itemUidInArray;
    },
    _computeAssociatedKeys: function(machine, keys) {
        return machine.keys || [];
    },
    computeMachineIp: function(machineips) {
        if (this.machine.public_ips) {
            return this.machine.public_ips[0]
        } else {
            return ''
        }
    },
    _isEqual: function(a, b) {
        return a === b;
    },
    _isMonitored: function(machine, monitoredMachines) {
        if (monitoredMachines) {
            var mach = monitoredMachines.base.find(function(m) {
                return m[1] == machine.id && m[0] == machine.cloud.id;
            }, this);
        }
        if (monitoredMachines && mach) {
            this.set('isMonitored', true);
        } else {
            this.set('isMonitored', false);
        }
    },
    _computeIsActivated: function(machine, monitoring){
        // if (!this.machine || this.model.monitoring || !this.model.monitoring.monitored_machines || !this.model.monitoring.monitored_machines[machine.uuid] || !this.model.monitoring.monitored_machines[machine.uuid].installation_status.activated_at)
        //     return false;
        // else
        if (this.model.monitoring.monitored_machines[machine.uuid])
            return this.model.monitoring.monitored_machines[machine.uuid].installation_status.activated_at;
    },
    _machineImage: function(id) {
        var image = this.model.imagesArray.find(function(image) {
            return image.id == id;
        }, this);
        if (image)
            return image.name;
        else
            return "";
    },
    confirmAction: function(action) {
        this._showDialog({
            title: action + ' Machine?',
            body: "You are about to " + action + " machine '" + this.machine.name + "'.",
            danger: false,
            reason: "machine." + action,
            action: action
        });
    },
    _showDialog: function(info) {
        var dialog = this.querySelector('#machinedialog');
        for (var i in info) {
            dialog[i] = info[i];
        }
        dialog._openDialog();
    },
    _showToast: function(msg) {
        var toast = this.querySelector('paper-toast');
        toast.text = msg;
        toast.show();
    },
    isState: function(machine) {
        return machine.state == machine.extra.status;
    },
    _computeIsloading: function(machine) {
        return !this.machine ? true : false;
    },
    disassociateKey: function(e) {
        var keyId = e.target['dataKeyid'];
        var keyName = e.target['dataKeyname'];

        // console.log('disassociateKey',keyId, keyName);

        this.set('disassociateKeyId', keyId);

        // console.log(this.disassociateKeyId);

        this._showDialog({
            title: 'Disassociate key',
            body: "You are about to disassociate key '" + keyName + "' from machine.",
            danger: false,
            reason: "disassociate.key",
            action: 'disassociate',
            key: keyId
        });
    },
    _disassociateKeyRequest: function(e) {
        this.set('isPendingKeyRequest', true);
    },
    _disassociateKeyResponse: function(e) {
        this.set('isPendingKeyRequest', false);
    },
    _disassociateKeyError: function(e) {
        this.set('isPendingKeyRequest', false);
    },
    _updateKeyLoader: function(e) {
        //console.log(e.detail);
        if (e.detail.request) {
            this.set('isPendingKeyRequest', true);
        } else if (e.detail.response) {
            this.set('isPendingKeyRequest', false);
        } else if (e.detail.error) {
            this.set('isPendingKeyRequest', false);
            this._showToast(e.detail.errormsg);
        }
    },
    _feedbackOnScript: function(e) {
        if (e.detail.response) {
            this._showToast('Script run request succeded. Script ' + this.model.scripts[e.detail.scriptId].name + ' has been queued for execution');
        }
        if (e.detail.error) {
            this._showToast(e.detail.errormsg);
        }
    },
    _feedbackOnRename: function(e) {
        console.log("_feedbackOnRename")
        if (e.detail.request) {
            this._showToast('Rename request sent. Waiting for machine to respond');
        }
        if (e.detail.response) {
            this._showToast('Renaming was successful.');
        }
        if (e.detail.error) {
            this._showToast(e.detail.errormsg);
        }
    },
    _feedbackOnRename: function(e){
        console.log("_feedbackOnRename")
        if (e.detail.request) {
            this._showToast('Rename request sent. Waiting for machine to respond');
        }
        if (e.detail.response) {
            this._showToast('Renaming was successful.');
        }
        if (e.detail.error) {
            this._showToast(e.detail.errormsg);
        }
    },
    _computeProbeData: function(machine, probes){
        if (this.model && this.model.probes && this.model.probes[machine.uuid] && this.model.probes[machine.uuid].loadavg.length)
            return this.model.probes[machine.uuid].loadavg[0]+", "+this.model.probes[machine.uuid].loadavg[1]+", "+this.model.probes[machine.uuid].loadavg[2]+" - "+this.model.probes[machine.uuid].cores+" cores. Last probe: "+moment(this.model.probes[machine.uuid].timestamp*1000).fromNow();
    },
    _computeDirtyCowAlert: function(machine, probes){
         var info = "";
         if (this.model && this.model.probes && this.model.probes[machine.uuid]){
             if (this.model.probes[machine.uuid].dirty_cow != undefined)
                 info += "Dirty COW vulnerability found. Update kernel.";
         }
         return info.length ? info : '';
     },
    itemProbeClasses: function(item, probes) {
        if (!probes) {
            return false;
        } else {
            if (!this.model || !this.model.probes || !this.model.probes[item.uuid] || !this.model.probes[item.uuid].loadavg) {
                return false;
            } else {
                var probe = this.model.probes[item.uuid].loadavg;
                var cores =  parseInt(this.model.probes[item.uuid].cores);
                var classes = '';
                var prefix = '';

                classes += this.loadToColor(parseFloat(probe[0]/cores), "short");
                classes += this.loadToColor(parseFloat(probe[1]/cores), "mid");
                classes += this.loadToColor(parseFloat(probe[2]/cores), "long");

                //has probe data
                if (classes != "")
                    classes += "hasprobe "

                return classes;
            }
        }
    },
     _computeProbeObj: function (machine, probes){
         if (this.model && this.model.probes && this.model.probes[machine.uuid] && this.model.probes[machine.uuid])
             return this.model.probes[machine.uuid];
     },
    loadToColor: function(load, prefix){
        if (load > 1.2)
            return prefix+"high ";
        else if (load > 0.8)
            return prefix+"medium ";
        else if (load > 0.6)
            return prefix+"eco ";
        else if (load > 0.2)
            return prefix+"low ";
        else
            return prefix+"low ";
    },
    readableUptime: function(str){
        if (str) {
            var a = str.split(" ")[0],
                b = str.split(" ")[1];
            return "Up "+a+". Idle:"+b;
        }
        else
            return "";

    }
});
</script>
